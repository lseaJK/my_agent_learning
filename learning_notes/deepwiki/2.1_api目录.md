ä»¥ä¸‹æ˜¯ `api` ç›®å½•ä¸‹ä¸»è¦æ–‡ä»¶çš„è¯¦ç»†ä»‹ç»ï¼ˆå·²è·³è¿‡å¤§æ¨¡å‹æ¥å£ç›¸å…³æ–‡ä»¶å¦‚ `openrouter_client.py`ã€`openai_client.py` ç­‰ï¼‰ï¼š


### 1. `websocket_wiki.py`
- **åŠŸèƒ½**ï¼šå®šä¹‰ WebSocket é€šä¿¡ä¸­ä½¿ç”¨çš„èŠå¤©æ¶ˆæ¯æ•°æ®æ¨¡å‹,ä¸“é—¨ç”¨äºè§„èŒƒå‰åç«¯é€šè¿‡ WebSocket ä¼ è¾“çš„èŠå¤©æ¶ˆæ¯æ ¼å¼ï¼ŒåŸºäº Pydantic å®ç°ä¸¥æ ¼çš„æ•°æ®æ ¡éªŒï¼Œç¡®ä¿æ¶ˆæ¯ç»“æ„åˆæ³•ã€å¯è§£æï¼Œæ˜¯ WebSocket é€šä¿¡çš„â€œæ•°æ®å¥‘çº¦â€ã€‚
- **ä½œç”¨**ï¼šå®šä¹‰ WebSocket èŠå¤©åœºæ™¯ä¸‹çš„æ¶ˆæ¯æ•°æ®ç»“æ„ï¼Œçº¦æŸæ¶ˆæ¯çš„å­—æ®µç±»å‹ã€å–å€¼èŒƒå›´å’Œå¿…å¡«æ€§ï¼Œé¿å…è„æ•°æ®å¯¼è‡´çš„é€šä¿¡å¼‚å¸¸æˆ–ä¸šåŠ¡é€»è¾‘é”™è¯¯ã€‚
- **æŠ€æœ¯åŸºåº§**ï¼šåŸºäº Pydantic `BaseModel`ï¼ˆPython æ•°æ®éªŒè¯/åºåˆ—åŒ–åº“ï¼‰ï¼Œå¤©ç„¶æ”¯æŒ JSON ä¸ Python å¯¹è±¡çš„äº’è½¬ï¼Œé€‚é… WebSocket ä»¥ JSON ä¸ºä¼ è¾“æ ¼å¼çš„ç‰¹æ€§ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šå‰åç«¯å®æ—¶èŠå¤©ï¼ˆå¦‚ Wiki é—®ç­”ã€æ–‡æ¡£å¯¹è¯ï¼‰çš„æ¶ˆæ¯æ”¶å‘æ ¡éªŒï¼Œæ˜¯ WebSocket è·¯ç”±å¤„ç†é€»è¾‘çš„åŸºç¡€ä¾èµ–ã€‚
- **æ ¸å¿ƒå†…å®¹**ï¼š  
  ä»…åŒ…å« `ChatMessage` ç±»ï¼ˆç»§æ‰¿è‡ª Pydantic çš„ `BaseModel`ï¼‰ï¼Œç”¨äºè§„èŒƒ WebSocket ä¼ è¾“çš„æ¶ˆæ¯æ ¼å¼ï¼š
  - `role`: å­—ç¬¦ä¸²ç±»å‹ï¼Œå–å€¼ä¸º `'user'` æˆ– `'assistant'`ï¼Œæ ‡è¯†æ¶ˆæ¯å‘é€è€…è§’è‰²ã€‚
  - `content`: å­—ç¬¦ä¸²ç±»å‹ï¼Œå­˜å‚¨æ¶ˆæ¯å†…å®¹ã€‚

```python
# 1. å¯¼å…¥æ ¸å¿ƒä¾èµ–
from pydantic import BaseModel, Field
from typing import Literal

# 2. æ ¸å¿ƒæ¶ˆæ¯æ¨¡å‹å®šä¹‰
class ChatMessage(BaseModel):
    """
    WebSocket èŠå¤©æ¶ˆæ¯æ•°æ®æ¨¡å‹
    çº¦æŸå‰åç«¯ä¼ è¾“çš„èŠå¤©æ¶ˆæ¯æ ¼å¼
    """
    # æ¶ˆæ¯å‘é€è€…è§’è‰²ï¼ˆä¸¥æ ¼é™åˆ¶ä»…æ”¯æŒ user/assistantï¼‰
    role: Literal["user", "assistant"] = Field(
        ...,  # å¿…å¡«å­—æ®µï¼ˆPydantic ç‰¹æ®Šå€¼ï¼Œä»£è¡¨ä¸å¯ç¼ºçœï¼‰
        description="æ¶ˆæ¯å‘é€è€…è§’è‰²ï¼šuserï¼ˆç”¨æˆ·ï¼‰/ assistantï¼ˆåŠ©æ‰‹/åç«¯ï¼‰"
    )
    # æ¶ˆæ¯å†…å®¹
    content: str = Field(
        ...,
        min_length=1,  # å†…å®¹ä¸å¯ä¸ºç©ºå­—ç¬¦ä¸²
        description="èŠå¤©æ¶ˆæ¯çš„å…·ä½“å†…å®¹ï¼ˆå¦‚ç”¨æˆ·é—®é¢˜ã€åŠ©æ‰‹å›ç­”ï¼‰"
    )

# ï¼ˆå¯é€‰æ‰©å±•ï¼‰WebSocket å“åº”å°è£…ï¼ˆè‹¥é¡¹ç›®æœ‰å¤šå±‚å°è£…ï¼‰
class WebSocketResponse(BaseModel):
    """WebSocket åç«¯å“åº”å°è£…ï¼ˆå¯é€‰ï¼‰"""
    code: int = Field(200, description="å“åº”çŠ¶æ€ç ï¼š200 æˆåŠŸ / 400 æ ¡éªŒå¤±è´¥")
    data: ChatMessage | None = Field(None, description="æ¶ˆæ¯ä¸»ä½“")
    msg: str = Field("success", description="å“åº”æç¤ºä¿¡æ¯")
```

| å…³è”æ¨¡å— | äº¤äº’é€»è¾‘ |
|----------|----------|
| `api/main.py`ï¼ˆWebSocket è·¯ç”±ï¼‰ | åç«¯ WebSocket ç«¯ç‚¹ä¼šå¯¼å…¥ `ChatMessage`ï¼Œæ¥æ”¶å‰ç«¯æ¶ˆæ¯åå…ˆæ ¡éªŒï¼Œå†å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼›å‘é€æ¶ˆæ¯æ—¶æ„é€  `ChatMessage` å®ä¾‹åè¿”å›ã€‚ |
| `api/rag.py`ï¼ˆå¯¹è¯è®°å¿†ï¼‰ | `Memory` ç±»å­˜å‚¨çš„å¯¹è¯è½®æ¬¡ï¼Œæœ¬è´¨æ˜¯ `ChatMessage` æ ¼å¼çš„â€œuser + assistantâ€ç»„åˆï¼Œä¿è¯å¯¹è¯å†å²çš„æ•°æ®ç»“æ„ç»Ÿä¸€ã€‚ |
| å‰ç«¯ WebSocket ä»£ç  | å‰ç«¯éœ€ä¸¥æ ¼æŒ‰ç…§ `ChatMessage` æ ¼å¼å‘é€ JSON æ¶ˆæ¯ï¼ˆå¦‚ `{"role":"user","content":"xxx"}`ï¼‰ï¼Œå¦åˆ™ä¼šè¢«åç«¯æ ¡éªŒæ‹’ç»ã€‚ |

---

### 2. `api.py`
è¯¥æ–‡ä»¶æ˜¯ DeepWiki-Open é¡¹ç›®åç«¯çš„**æ ¸å¿ƒæ¥å£ä¸­æ¢**ï¼ŒåŸºäº FastAPI æ¡†æ¶å®ç°äº†æ‰€æœ‰ HTTP æ¥å£çš„å®šä¹‰ã€æ•°æ®æ ¡éªŒã€ä¸šåŠ¡é€»è¾‘ç¼–æ’ï¼Œæ˜¯å‰ç«¯/å®¢æˆ·ç«¯ä¸åç«¯ä¸šåŠ¡å±‚äº¤äº’çš„â€œæ€»å…¥å£â€ã€‚å®ƒæ•´åˆäº† Pydantic æ•°æ®æ ¡éªŒã€CORS è·¨åŸŸé…ç½®ã€ä¸šåŠ¡é€»è¾‘è°ƒç”¨ç­‰èƒ½åŠ›ï¼Œè¦†ç›– Wiki ç®¡ç†ã€ä»“åº“æ“ä½œã€é…ç½®æŸ¥è¯¢ã€æ•°æ®å¯¼å‡ºç­‰æ ¸å¿ƒåœºæ™¯ï¼Œæ˜¯æ•´ä¸ªé¡¹ç›®åç«¯çš„â€œæ¥å£å¤§è„‘â€ã€‚

- **åŠŸèƒ½**ï¼šFastAPI åº”ç”¨çš„æ ¸å¿ƒå®ç°ï¼ŒåŒ…å«æ¥å£å®šä¹‰ã€æ•°æ®æ¨¡å‹ã€ä¸šåŠ¡é€»è¾‘ç­‰ã€‚
- **æ ¸å¿ƒå†…å®¹**ï¼š  
  - **åº”ç”¨åˆå§‹åŒ–**ï¼šåˆ›å»º FastAPI å®ä¾‹ï¼Œé…ç½® CORSï¼ˆå…è®¸æ‰€æœ‰æ¥æºã€æ–¹æ³•å’Œå¤´éƒ¨ï¼‰ã€‚
  - **æ•°æ®æ¨¡å‹ï¼ˆPydantic Modelsï¼‰**ï¼šå®šä¹‰äº†å¤šä¸ªæ•°æ®ç»“æ„ï¼Œç”¨äºæ¥å£è¯·æ±‚/å“åº”æ ¡éªŒï¼š
    - `WikiPage`ï¼šç»´åŸºé¡µé¢æ¨¡å‹ï¼ˆåŒ…å« `id`ã€`title`ã€`content` ç­‰å­—æ®µï¼‰ã€‚
    - `RepoInfo`ï¼šä»“åº“ä¿¡æ¯æ¨¡å‹ï¼ˆåŒ…å« `owner`ã€`repo`ã€`token` ç­‰ä»“åº“ç›¸å…³ä¿¡æ¯ï¼‰ã€‚
    - `WikiStructureModel`ï¼šæ•´ä½“ç»´åŸºç»“æ„æ¨¡å‹ï¼ˆåŒ…å«é¡µé¢ã€ç« èŠ‚ç­‰å±‚çº§å…³ç³»ï¼‰ã€‚
    - å…¶ä»–æ¨¡å‹ï¼šå¦‚ `WikiCacheData`ï¼ˆç¼“å­˜æ•°æ®ï¼‰ã€`WikiExportRequest`ï¼ˆå¯¼å‡ºè¯·æ±‚ï¼‰ã€`ModelConfig`ï¼ˆæ¨¡å‹é…ç½®ï¼‰ç­‰ã€‚
  - **API æ¥å£**ï¼šå®ç°äº†å¤šä¸ª HTTP ç«¯ç‚¹ï¼š
    - `/lang/config`ï¼šè·å–è¯­è¨€é…ç½®ã€‚
    - `/auth/status`ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯ã€‚
    - `/auth/validate`ï¼šéªŒè¯è®¤è¯ç ã€‚
    - `/models/config`ï¼šè·å–å¯ç”¨çš„æ¨¡å‹æä¾›å•†åŠæ¨¡å‹åˆ—è¡¨ã€‚
    - `/export/wiki`ï¼šå¯¼å‡ºç»´åŸºå†…å®¹ï¼ˆæ”¯æŒ Markdown æˆ– JSON æ ¼å¼ï¼‰ã€‚
    - `/local_repo/structure`ï¼šè·å–æœ¬åœ°ä»“åº“çš„æ–‡ä»¶ç»“æ„å’Œ README å†…å®¹ã€‚

```python
# ====================== 1. ä¾èµ–å¯¼å…¥ ======================
# FastAPI æ ¸å¿ƒä¾èµ–
from fastapi import FastAPI, HTTPException, Depends, Query, Body
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse, FileResponse
# Pydantic æ•°æ®æ ¡éªŒ
from pydantic import BaseModel, Field, validator
from typing import List, Dict, Optional, Literal, Any
# é¡¹ç›®å†…éƒ¨æ¨¡å—
from api.config import get_model_config
from api.data_pipeline import clone_repo, parse_repo_structure, export_wiki_content
from api.rag import Memory
from api.logging_config import logger
# ç¬¬ä¸‰æ–¹å·¥å…·
import os
import json
from datetime import datetime
import uuid

# ====================== 2. åº”ç”¨åˆå§‹åŒ– & è·¨åŸŸé…ç½® ======================
# åˆ›å»º FastAPI å®ä¾‹ï¼Œé…ç½®æ–‡æ¡£ä¿¡æ¯
app = FastAPI(
    title="DeepWiki-Open API",
    description="DeepWiki-Open åç«¯æ¥å£æ–‡æ¡£ï¼ˆWiki ç®¡ç†/ä»“åº“æ“ä½œ/æ¨¡å‹é…ç½®ï¼‰",
    version="1.0.0",
    docs_url="/docs",  # Swagger æ–‡æ¡£è·¯å¾„
    redoc_url="/redoc"  # ReDoc æ–‡æ¡£è·¯å¾„
)

# é…ç½® CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰- å‰åç«¯åˆ†ç¦»å¿…é€‰
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # å¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰æ¥æºï¼ˆç”Ÿäº§ç¯å¢ƒéœ€é™å®šå…·ä½“åŸŸåï¼‰
    allow_credentials=True,
    allow_methods=["*"],  # å…è®¸æ‰€æœ‰ HTTP æ–¹æ³•ï¼ˆGET/POST/PUT/DELETE ç­‰ï¼‰
    allow_headers=["*"],  # å…è®¸æ‰€æœ‰è¯·æ±‚å¤´
)

# ====================== 3. æ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼ˆPydanticï¼‰ ======================
# 3.1 Wiki é¡µé¢åŸºç¡€æ¨¡å‹
class WikiPage(BaseModel):
    """å•æ¡ Wiki é¡µé¢æ•°æ®æ¨¡å‹ï¼ˆç”¨äºå­˜å‚¨/è¿”å› Wiki é¡µé¢ä¿¡æ¯ï¼‰"""
    id: str = Field(default_factory=lambda: str(uuid.uuid4()), description="Wiki é¡µé¢å”¯ä¸€ID")
    title: str = Field(..., min_length=1, max_length=200, description="Wiki é¡µé¢æ ‡é¢˜")
    content: str = Field(..., description="Wiki é¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰")
    create_time: datetime = Field(default_factory=datetime.utcnow, description="åˆ›å»ºæ—¶é—´ï¼ˆUTCï¼‰")
    update_time: datetime = Field(default_factory=datetime.utcnow, description="æ›´æ–°æ—¶é—´ï¼ˆUTCï¼‰")
    
    # è‡ªå®šä¹‰æ ¡éªŒå™¨ï¼šæ ‡é¢˜å»é‡é¦–å°¾ç©ºæ ¼
    @validator("title")
    def title_strip(cls, v):
        return v.strip()

# 3.2 ä»“åº“ä¿¡æ¯æ¨¡å‹ï¼ˆç”¨äºå…‹éš†/è§£æä»“åº“ï¼‰
class RepoInfo(BaseModel):
    """ä»£ç ä»“åº“ä¿¡æ¯æ¨¡å‹ï¼ˆç”¨äºè·å–ä»“åº“ç»“æ„/å†…å®¹ï¼‰"""
    owner: str = Field(..., description="ä»“åº“æ‰€æœ‰è€…ï¼ˆå¦‚ GitHub ç”¨æˆ·å/ç»„ç»‡åï¼‰")
    repo: str = Field(..., description="ä»“åº“åç§°")
    token: Optional[str] = Field(None, description="ä»“åº“è®¿é—® Tokenï¼ˆç§æœ‰ä»“åº“å¿…å¡«ï¼‰")
    branch: str = Field(default="main", description="ä»“åº“åˆ†æ”¯ï¼ˆé»˜è®¤ mainï¼‰")
    
    # è‡ªå®šä¹‰æ ¡éªŒå™¨ï¼šæ£€æŸ¥ä»“åº“åç§°åˆæ³•æ€§
    @validator("repo")
    def repo_name_valid(cls, v):
        if not v.strip() or "/" in v:
            raise ValueError("ä»“åº“åç§°ä¸å¯åŒ…å« '/' ä¸”ä¸èƒ½ä¸ºç©º")
        return v.strip()

# 3.3 Wiki å¯¼å‡ºè¯·æ±‚æ¨¡å‹
class WikiExportRequest(BaseModel):
    """Wiki å¯¼å‡ºè¯·æ±‚æ¨¡å‹ï¼ˆæŒ‡å®šå¯¼å‡ºæ ¼å¼/èŒƒå›´ï¼‰"""
    format: Literal["markdown", "json"] = Field(default="markdown", description="å¯¼å‡ºæ ¼å¼")
    page_ids: Optional[List[str]] = Field(None, description="æŒ‡å®šå¯¼å‡ºçš„é¡µé¢IDï¼ˆä¸ºç©ºåˆ™å¯¼å‡ºå…¨éƒ¨ï¼‰")
    include_metadata: bool = Field(default=True, description="æ˜¯å¦åŒ…å«å…ƒæ•°æ®ï¼ˆåˆ›å»ºæ—¶é—´/æ›´æ–°æ—¶é—´ç­‰ï¼‰")

# 3.4 æ¨¡å‹é…ç½®å“åº”æ¨¡å‹
class ModelConfig(BaseModel):
    """å¤§æ¨¡å‹é…ç½®å“åº”æ¨¡å‹ï¼ˆè¿”å›å¯ç”¨æ¨¡å‹åŠå‚æ•°ï¼‰"""
    provider: str = Field(..., description="æ¨¡å‹æä¾›å•†ï¼ˆå¦‚ google/openai/ollamaï¼‰")
    model_name: str = Field(..., description="æ¨¡å‹åç§°ï¼ˆå¦‚ gemini-pro/gpt-3.5-turboï¼‰")
    default_params: Dict[str, Any] = Field(..., description="æ¨¡å‹é»˜è®¤å‚æ•°ï¼ˆå¦‚ temperature/max_tokensï¼‰")

# 3.5 è¯­è¨€é…ç½®æ¨¡å‹
class LangConfig(BaseModel):
    """è¯­è¨€é…ç½®æ¨¡å‹ï¼ˆè¿”å›æ”¯æŒçš„è¯­è¨€åˆ—è¡¨ï¼‰"""
    supported_langs: List[str] = Field(default=["zh-CN", "en-US"], description="æ”¯æŒçš„è¯­è¨€")
    default_lang: str = Field(default="zh-CN", description="é»˜è®¤è¯­è¨€")

# ====================== 4. æ ¸å¿ƒ API æ¥å£å®šä¹‰ ======================
# 4.1 é…ç½®ç±»æ¥å£ - è·å–è¯­è¨€é…ç½®
@app.get("/lang/config", response_model=LangConfig, tags=["é…ç½®ç®¡ç†"])
async def get_lang_config():
    """
    è·å–ç³»ç»Ÿè¯­è¨€é…ç½®
    è¿”å›æ”¯æŒçš„è¯­è¨€åˆ—è¡¨åŠé»˜è®¤è¯­è¨€
    """
    try:
        logger.info("è·å–è¯­è¨€é…ç½®è¯·æ±‚")
        return LangConfig()  # è¿”å›é¢„è®¾çš„è¯­è¨€é…ç½®
    except Exception as e:
        logger.error(f"è·å–è¯­è¨€é…ç½®å¤±è´¥ï¼š{str(e)}")
        raise HTTPException(status_code=500, detail=f"è¯­è¨€é…ç½®è·å–å¤±è´¥ï¼š{str(e)}")

# 4.2 è®¤è¯ç±»æ¥å£ - æ£€æŸ¥è®¤è¯çŠ¶æ€
@app.get("/auth/status", tags=["è®¤è¯ç®¡ç†"])
async def check_auth_status():
    """
    æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦éœ€è¦è®¤è¯ï¼ˆå¦‚æ˜¯å¦é…ç½®äº†è®¤è¯ç ï¼‰
    è¿”å›æ˜¯å¦éœ€è¦è®¤è¯çš„å¸ƒå°”å€¼
    """
    try:
        # ä»ç¯å¢ƒå˜é‡/é…ç½®æ–‡ä»¶è¯»å–è®¤è¯å¼€å…³
        auth_required = os.getenv("AUTH_REQUIRED", "false").lower() == "true"
        return {"auth_required": auth_required, "message": "è®¤è¯çŠ¶æ€æŸ¥è¯¢æˆåŠŸ"}
    except Exception as e:
        logger.error(f"æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥ï¼š{str(e)}")
        raise HTTPException(status_code=500, detail=f"è®¤è¯çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼š{str(e)}")

# 4.3 è®¤è¯ç±»æ¥å£ - éªŒè¯è®¤è¯ç 
@app.post("/auth/validate", tags=["è®¤è¯ç®¡ç†"])
async def validate_auth_code(code: str = Body(..., embed=True)):
    """
    éªŒè¯ç”¨æˆ·è¾“å…¥çš„è®¤è¯ç æ˜¯å¦æ­£ç¡®
    """
    try:
        # ä»ç¯å¢ƒå˜é‡è¯»å–é¢„è®¾è®¤è¯ç 
        correct_code = os.getenv("AUTH_CODE", "")
        if not correct_code:
            return {"valid": True, "message": "æœªé…ç½®è®¤è¯ç ï¼Œæ— éœ€éªŒè¯"}
        if code.strip() == correct_code:
            logger.info("è®¤è¯ç éªŒè¯æˆåŠŸ")
            return {"valid": True, "message": "è®¤è¯é€šè¿‡"}
        else:
            logger.warning("è®¤è¯ç éªŒè¯å¤±è´¥ï¼šè¾“å…¥é”™è¯¯")
            return {"valid": False, "message": "è®¤è¯ç é”™è¯¯"}
    except Exception as e:
        logger.error(f"è®¤è¯ç éªŒè¯å¤±è´¥ï¼š{str(e)}")
        raise HTTPException(status_code=500, detail=f"è®¤è¯éªŒè¯å¤±è´¥ï¼š{str(e)}")

# 4.4 æ¨¡å‹é…ç½®æ¥å£ - è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
@app.get("/models/config", response_model=List[ModelConfig], tags=["æ¨¡å‹ç®¡ç†"])
async def get_models_config(provider: Optional[str] = Query(None, description="æŒ‡å®šæ¨¡å‹æä¾›å•†")):
    """
    è·å–å¯ç”¨çš„å¤§æ¨¡å‹é…ç½®
    æ”¯æŒæŒ‰æä¾›å•†è¿‡æ»¤ï¼ˆå¦‚ä»…è¿”å› google çš„æ¨¡å‹ï¼‰
    """
    try:
        logger.info(f"è·å–æ¨¡å‹é…ç½®è¯·æ±‚ï¼Œæä¾›å•†è¿‡æ»¤ï¼š{provider}")
        # è°ƒç”¨ config.py çš„ get_model_config å‡½æ•°è·å–é…ç½®
        all_configs = get_model_config(provider=provider)
        # è½¬æ¢ä¸º ModelConfig æ¨¡å‹åˆ—è¡¨ï¼ˆä¿è¯å“åº”æ ¼å¼ç»Ÿä¸€ï¼‰
        model_config_list = [
            ModelConfig(
                provider=cfg["provider"],
                model_name=cfg["model_name"],
                default_params=cfg["default_params"]
            ) for cfg in all_configs
        ]
        return model_config_list
    except Exception as e:
        logger.error(f"è·å–æ¨¡å‹é…ç½®å¤±è´¥ï¼š{str(e)}")
        raise HTTPException(status_code=500, detail=f"æ¨¡å‹é…ç½®è·å–å¤±è´¥ï¼š{str(e)}")

# 4.5 Wiki å¯¼å‡ºæ¥å£ - å¯¼å‡º Wiki å†…å®¹
@app.post("/export/wiki", tags=["Wiki ç®¡ç†"])
async def export_wiki(request: WikiExportRequest):
    """
    å¯¼å‡º Wiki å†…å®¹
    æ”¯æŒ Markdown/JSON æ ¼å¼ï¼Œå¯æŒ‡å®šå¯¼å‡ºé¡µé¢ID
    """
    try:
        logger.info(f"Wiki å¯¼å‡ºè¯·æ±‚ï¼šæ ¼å¼={request.format}ï¼Œé¡µé¢ID={request.page_ids}")
        # è°ƒç”¨ data_pipeline.py çš„ export_wiki_content å‡½æ•°å¤„ç†å¯¼å‡º
        export_path = export_wiki_content(
            format=request.format,
            page_ids=request.page_ids,
            include_metadata=request.include_metadata
        )
        # è¿”å›æ–‡ä»¶ä¸‹è½½å“åº”ï¼ˆå¦‚æœæ˜¯æ–‡ä»¶å¯¼å‡ºï¼‰
        if os.path.exists(export_path):
            return FileResponse(
                path=export_path,
                filename=f"deepwiki_export_{datetime.now().strftime('%Y%m%d%H%M%S')}.{request.format}",
                media_type="application/octet-stream"
            )
        else:
            raise HTTPException(status_code=404, detail="å¯¼å‡ºæ–‡ä»¶ç”Ÿæˆå¤±è´¥")
    except HTTPException as e:
        raise e  # ç›´æ¥æŠ›å‡ºå·²å®šä¹‰çš„ HTTP å¼‚å¸¸
    except Exception as e:
        logger.error(f"Wiki å¯¼å‡ºå¤±è´¥ï¼š{str(e)}")
        raise HTTPException(status_code=500, detail=f"Wiki å¯¼å‡ºå¤±è´¥ï¼š{str(e)}")

# 4.6 ä»“åº“æ“ä½œæ¥å£ - è·å–æœ¬åœ°ä»“åº“ç»“æ„
@app.post("/local_repo/structure", tags=["ä»“åº“ç®¡ç†"])
async def get_local_repo_structure(repo_info: RepoInfo):
    """
    å…‹éš†æŒ‡å®šä»“åº“ï¼ˆè‹¥æœªå…‹éš†ï¼‰å¹¶è¿”å›ä»“åº“æ–‡ä»¶ç»“æ„ + README å†…å®¹
    """
    try:
        logger.info(f"è·å–ä»“åº“ç»“æ„è¯·æ±‚ï¼š{repo_info.owner}/{repo_info.repo}ï¼ˆåˆ†æ”¯ï¼š{repo_info.branch}ï¼‰")
        # 1. å…‹éš†ä»“åº“ï¼ˆè°ƒç”¨ data_pipeline.py çš„ clone_repo å‡½æ•°ï¼‰
        repo_path = await clone_repo(
            owner=repo_info.owner,
            repo=repo_info.repo,
            token=repo_info.token,
            branch=repo_info.branch
        )
        # 2. è§£æä»“åº“ç»“æ„ï¼ˆè°ƒç”¨ data_pipeline.py çš„ parse_repo_structure å‡½æ•°ï¼‰
        repo_structure = parse_repo_structure(repo_path)
        # 3. è¿”å›ä»“åº“ç»“æ„ + README å†…å®¹
        return {
            "repo_path": repo_path,
            "structure": repo_structure["structure"],
            "readme_content": repo_structure["readme_content"],
            "message": "ä»“åº“ç»“æ„è·å–æˆåŠŸ"
        }
    except Exception as e:
        logger.error(f"è·å–ä»“åº“ç»“æ„å¤±è´¥ï¼š{str(e)}")
        raise HTTPException(status_code=500, detail=f"ä»“åº“ç»“æ„è·å–å¤±è´¥ï¼š{str(e)}")

# ====================== 5. å…¨å±€å¼‚å¸¸å¤„ç†ï¼ˆå¯é€‰ï¼‰ ======================
@app.exception_handler(HTTPException)
async def http_exception_handler(request, exc):
    """è‡ªå®šä¹‰ HTTP å¼‚å¸¸å¤„ç†ï¼šç»Ÿä¸€è¿”å›æ ¼å¼"""
    logger.error(f"HTTP å¼‚å¸¸ï¼šè·¯å¾„={request.url.path}ï¼ŒçŠ¶æ€ç ={exc.status_code}ï¼Œè¯¦æƒ…={exc.detail}")
    return JSONResponse(
        status_code=exc.status_code,
        content={"code": exc.status_code, "message": exc.detail, "data": None}
    )

@app.exception_handler(Exception)
async def general_exception_handler(request, exc):
    """å…¨å±€é€šç”¨å¼‚å¸¸å¤„ç†ï¼šæ•è·æ‰€æœ‰æœªå¤„ç†çš„å¼‚å¸¸"""
    logger.error(f"å…¨å±€å¼‚å¸¸ï¼šè·¯å¾„={request.url.path}ï¼Œå¼‚å¸¸={str(exc)}", exc_info=True)
    return JSONResponse(
        status_code=500,
        content={"code": 500, "message": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯", "data": None}
    )
```

- **FastAPI å®ä¾‹é…ç½®**ï¼š  
  æŒ‡å®š `title`/`description`/`version` ç”¨äºè‡ªåŠ¨ç”Ÿæˆçš„æ¥å£æ–‡æ¡£ï¼Œ`docs_url`/`redoc_url` æ˜¯ FastAPI è‡ªå¸¦çš„æ–‡æ¡£å…¥å£ï¼ˆå¼€å‘è°ƒè¯•ç¥å™¨ï¼‰ã€‚
- **CORS é…ç½®ç»†èŠ‚**ï¼š  
  - `allow_origins=["*"]`ï¼šå¼€å‘ç¯å¢ƒå®½æ¾é…ç½®ï¼Œç”Ÿäº§ç¯å¢ƒéœ€æ”¹ä¸ºå…·ä½“å‰ç«¯åŸŸåï¼ˆå¦‚ `["https://wiki.example.com"]`ï¼‰ï¼Œé¿å…è·¨åŸŸå®‰å…¨é£é™©ï¼›  
  - `allow_credentials=True`ï¼šå…è®¸å‰ç«¯æºå¸¦ Cookie/è®¤è¯å¤´ï¼ˆè‹¥æœ‰è®¤è¯åœºæ™¯ï¼‰ï¼›  
  - `allow_methods=["*"]`ï¼šæ”¯æŒæ‰€æœ‰ HTTP æ–¹æ³•ï¼Œæ— éœ€é€ä¸ªé…ç½® GET/POST/PUT ç­‰ã€‚

**æ¥å£å±‚ï¼šæŒ‰ä¸šåŠ¡åŸŸåˆ†ç»„ï¼Œé€»è¾‘æ¸…æ™°**
æ¥å£é€šè¿‡ `tags` åˆ†ç»„ï¼ˆå¦‚â€œé…ç½®ç®¡ç†â€/â€œè®¤è¯ç®¡ç†â€ï¼‰ï¼ŒFastAPI æ®æ­¤åœ¨ `/docs` ä¸­åˆ†ç±»å±•ç¤ºæ¥å£ï¼Œæå‡æ–‡æ¡£å¯è¯»æ€§ã€‚æ ¸å¿ƒæ¥å£çš„ä¸šåŠ¡é€»è¾‘é“¾è·¯ï¼š

| æ¥å£è·¯å¾„                | æ ¸å¿ƒä¸šåŠ¡é“¾è·¯                                                                 |
|-------------------------|------------------------------------------------------------------------------|
| `/lang/config`          | è¯»å–é¢„è®¾é…ç½® â†’ è¿”å›è¯­è¨€åˆ—è¡¨ + é»˜è®¤è¯­è¨€ â†’ å¼‚å¸¸æ•è·å¹¶è®°å½•æ—¥å¿—                   |
| `/auth/validate`        | è¯»å–ç¯å¢ƒå˜é‡è®¤è¯ç  â†’ æ ¡éªŒç”¨æˆ·è¾“å…¥ â†’ è¿”å›éªŒè¯ç»“æœ â†’ æ—¥å¿—è®°å½•ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰      |
| `/models/config`        | è°ƒç”¨ `config.py` çš„ `get_model_config` â†’ è½¬æ¢ä¸ºç»Ÿä¸€å“åº”æ¨¡å‹ â†’ è¿”å›æ¨¡å‹åˆ—è¡¨   |
| `/export/wiki`          | æ¥æ”¶å¯¼å‡ºå‚æ•° â†’ è°ƒç”¨ `export_wiki_content` ç”Ÿæˆæ–‡ä»¶ â†’ è¿”å›æ–‡ä»¶ä¸‹è½½å“åº”        |
| `/local_repo/structure` | æ ¡éªŒä»“åº“ä¿¡æ¯ â†’ å…‹éš†ä»“åº“ï¼ˆè‹¥æœªå…‹éš†ï¼‰ â†’ è§£ææ–‡ä»¶ç»“æ„ â†’ è¿”å›ç»“æ„ + README å†…å®¹   |

**ä¸å…¶ä»–æ¨¡å—çš„å…³è”é€»è¾‘**
| å…³è”æ¨¡å—                | äº¤äº’æ–¹å¼                                                                 |
|-------------------------|--------------------------------------------------------------------------|
| `api/config.py`         | æ¥å£ `/models/config` è°ƒç”¨ `get_model_config` è·å–æ¨¡å‹é…ç½®               |
| `api/data_pipeline.py`  | æ¥å£ `/local_repo/structure` è°ƒç”¨ `clone_repo`/`parse_repo_structure`ï¼›<br>`/export/wiki` è°ƒç”¨ `export_wiki_content` |
| `api/logging_config.py` | é€šè¿‡ `logger` è®°å½•æ¥å£è¯·æ±‚/å¼‚å¸¸æ—¥å¿—ï¼ˆæ—¥å¿—é…ç½®ç”±è¯¥æ¨¡å—åˆå§‹åŒ–ï¼‰             |
| `api/rag.py`            | è‹¥æ¥å£æ¶‰åŠå¯¹è¯è®°å¿†ï¼ˆå¦‚ Wiki é—®ç­”ï¼‰ï¼Œä¼šè°ƒç”¨ `Memory` ç±»ç®¡ç†å¯¹è¯å†å²        |
| ç¯å¢ƒå˜é‡                | è¯»å– `AUTH_REQUIRED`/`AUTH_CODE` ç­‰é…ç½®ï¼Œå®ç°è®¤è¯å¼€å…³/è®¤è¯ç æ ¡éªŒ         |

---

### 3. `simple_chat.py`
- **åŠŸèƒ½**ï¼šæä¾›åŸºç¡€çš„å¥åº·æ£€æŸ¥æ¥å£ã€‚
- **æ ¸å¿ƒå†…å®¹**ï¼š  
  å®šä¹‰æ ¹è·¯å¾„ `/` çš„ GET æ¥å£ï¼Œè¿”å› API è¿è¡ŒçŠ¶æ€å’Œæ–‡æ¡£å¯¼èˆªæç¤ºï¼ˆå¦‚ `{"status": "API is running", "message": "Navigate to /docs for API documentation"}`ï¼‰ã€‚

```python
# ====================== 1. æ ¸å¿ƒä¾èµ–å¯¼å…¥ ======================
# FastAPI æ ¸å¿ƒï¼šè·¯ç”±å®šä¹‰ã€å“åº”æ ¼å¼æ§åˆ¶
from fastapi import FastAPI, APIRouter
from fastapi.responses import JSONResponse
# ç±»å‹æ³¨è§£ï¼šæå‡ä»£ç å¯è¯»æ€§ï¼Œè¾…åŠ© FastAPI ç”Ÿæˆç²¾å‡†æ¥å£æ–‡æ¡£
from typing import Dict, Any
# ï¼ˆå¯é€‰ï¼‰æ—¶é—´å·¥å…·ï¼šå¢å¼ºå¥åº·æ£€æŸ¥çš„æ—¶é—´ç»´åº¦
from datetime import datetime

# ====================== 2. è·¯ç”±åˆå§‹åŒ–ï¼ˆæ¨¡å—åŒ–æ ¸å¿ƒï¼‰ ======================
# å®šä¹‰ç‹¬ç«‹è·¯ç”±å®ä¾‹ï¼ˆè€Œéç›´æ¥ç”¨ FastAPI appï¼‰ï¼Œä¾¿äºæ•´åˆåˆ°ä¸»æœåŠ¡
router = APIRouter(
    tags=["åŸºç¡€æ£€æŸ¥"],  # æ¥å£æ–‡æ¡£ä¸­åˆ†ç»„åç§°ï¼ˆ/docs ä¸­æ˜¾ç¤ºä¸ºâ€œåŸºç¡€æ£€æŸ¥â€åˆ†ç±»ï¼‰
    prefix="",          # è·¯ç”±å‰ç¼€ï¼ˆä¸ºç©ºåˆ™æ¥å£ç›´æ¥æ˜ å°„åˆ°æ ¹è·¯å¾„ï¼‰
    responses={         # é¢„è®¾å“åº”çŠ¶æ€ç è¯´æ˜ï¼ˆå¢å¼ºæ–‡æ¡£å¯è¯»æ€§ï¼‰
        200: {"description": "æœåŠ¡æ­£å¸¸è¿è¡Œ"},
        500: {"description": "æœåŠ¡å†…éƒ¨é”™è¯¯"}
    }
)

# ====================== 3. æ ¸å¿ƒæ¥å£ï¼šæ ¹è·¯å¾„å¥åº·æ£€æŸ¥ ======================
@router.get(
    "/",                # æ¥å£è·¯å¾„ï¼šæ ¹è·¯å¾„ï¼ˆGET æ–¹æ³•ï¼‰
    summary="API æœåŠ¡å¥åº·æ£€æŸ¥",  # æ¥å£ç®€çŸ­æè¿°ï¼ˆæ–‡æ¡£ä¸­æ˜¾ç¤ºï¼‰
    response_description="è¿”å›æœåŠ¡è¿è¡ŒçŠ¶æ€åŠæ–‡æ¡£è®¿é—®æŒ‡å¼•"  # å“åº”æè¿°
)
async def root() -> Dict[str, Any]:
    """
    ã€æ ¸å¿ƒåŠŸèƒ½ã€‘API æœåŠ¡å­˜æ´»æ¢é’ˆ
    - éªŒè¯ Uvicorn + FastAPI æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨
    - æ— éœ€ä»»ä½•ä¸šåŠ¡ä¾èµ–ï¼Œå³ä½¿å¤§æ¨¡å‹/ä»“åº“é…ç½®é”™è¯¯ä¹Ÿèƒ½æ­£å¸¸è¿”å›
    - å¼•å¯¼ç”¨æˆ·è®¿é—®è‡ªåŠ¨ç”Ÿæˆçš„æ¥å£æ–‡æ¡£
    """
    # å“åº”ä½“ï¼šç»“æ„åŒ–è¿”å›æ ¸å¿ƒä¿¡æ¯
    response_data = {
        "status": "API is running",          # æœåŠ¡çŠ¶æ€ï¼ˆå›ºå®šæ ‡è¯†ï¼‰
        "timestamp": datetime.utcnow().isoformat(),  # å“åº”æ—¶é—´ï¼ˆUTC æ ‡å‡†æ—¶é—´ï¼‰
        "message": "Navigate to /docs for API documentation",  # æ–‡æ¡£æŒ‡å¼•
        "docs": {
            "swagger": "/docs",              # Swagger äº¤äº’å¼æ–‡æ¡£
            "redoc": "/redoc"                # ReDoc ç®€æ´ç‰ˆæ–‡æ¡£
        },
        "note": "This is a health check endpoint (no business logic involved)"
    }
    # æ˜¾å¼è¿”å› JSON å“åº”ï¼ˆçŠ¶æ€ç  200ï¼‰
    return JSONResponse(
        content=response_data,
        status_code=200,
        headers={"X-DeepWiki-Version": "1.0.0"}  # è‡ªå®šä¹‰å“åº”å¤´ï¼ˆç‰ˆæœ¬æ ‡è¯†ï¼‰
    )

# ====================== 4. å¯é€‰æ‰©å±•ï¼šæœ€ç®€èŠå¤©æµ‹è¯•æ¥å£ ======================
@router.get(
    "/simple-chat",     # æ¥å£è·¯å¾„ï¼š/simple-chatï¼ˆGET æ–¹æ³•ï¼‰
    summary="æœ€ç®€èŠå¤©æµ‹è¯•",
    response_description="è¿”å›ç¤ºä¾‹å“åº”ï¼ˆæ— å®é™… AI è°ƒç”¨ï¼‰"
)
async def simple_chat(
    # æŸ¥è¯¢å‚æ•°ï¼šç”¨æˆ·è¾“å…¥ï¼ˆå¯é€‰ï¼Œé»˜è®¤å€¼ "Hello DeepWiki"ï¼‰
    query: str = "Hello DeepWiki"
) -> Dict[str, Any]:
    """
    ã€è°ƒè¯•ç”¨ã€‘æœ€ç®€èŠå¤©æ¥å£ï¼ˆæ— ä¸šåŠ¡é€»è¾‘ï¼‰
    - éªŒè¯æ¥å£å‚æ•°æ¥æ”¶ã€å“åº”æ ¼å¼æ˜¯å¦ç¬¦åˆé¢„æœŸ
    - å“åº”æ ¼å¼å¯¹é½ websocket_wiki.py çš„ ChatMessage æ¨¡å‹
    - æ— å¤§æ¨¡å‹è°ƒç”¨ã€æ— ä»“åº“æ“ä½œï¼Œä»…åšå‚æ•°å›æ˜¾
    """
    # æ¨¡ä»¿ ChatMessage æ¨¡å‹çš„å“åº”æ ¼å¼ï¼ˆä¿æŒé¡¹ç›®æ ¼å¼ç»Ÿä¸€ï¼‰
    return {
        "role": "assistant",          # è§’è‰²ï¼ˆåŠ©æ‰‹ï¼‰
        "content": f"âœ… Received your query: {query}\nğŸ’¡ This is a TEST response (no AI involved).",
        "status": "success",
        "timestamp": datetime.utcnow().isoformat()
    }

# ====================== 5. ç‹¬ç«‹å¯åŠ¨å…¥å£ï¼ˆä»…ç”¨äºæ¨¡å—æµ‹è¯•ï¼‰ ======================
if __name__ == "__main__":
    """
    å•ç‹¬æµ‹è¯•è¯¥æ¨¡å—çš„å…¥å£ï¼ˆç”Ÿäº§ç¯å¢ƒä¸ä½¿ç”¨ï¼‰
    è¿è¡Œæ–¹å¼ï¼špython api/simple_chat.py
    è®¿é—®åœ°å€ï¼šhttp://127.0.0.1:8001/ æˆ– http://127.0.0.1:8001/simple-chat
    """
    import uvicorn  # ä»…åœ¨å•ç‹¬æµ‹è¯•æ—¶å¯¼å…¥

    # åˆ›å»ºä¸´æ—¶ FastAPI å®ä¾‹ï¼ŒæŒ‚è½½å½“å‰è·¯ç”±
    test_app = FastAPI(title="Simple Chat Test API")
    test_app.include_router(router)

    # å¯åŠ¨ä¸´æ—¶æµ‹è¯•æœåŠ¡
    uvicorn.run(
        test_app,
        host="127.0.0.1",  # ä»…æœ¬æœºå¯è®¿é—®ï¼ˆæµ‹è¯•å®‰å…¨ï¼‰
        port=8001,         # ç‹¬ç«‹ç«¯å£ï¼ˆé¿å…ä¸ä¸»æœåŠ¡å†²çªï¼‰
        reload=True        # çƒ­é‡è½½ï¼ˆä¿®æ”¹ä»£ç è‡ªåŠ¨é‡å¯ï¼‰
    )
```

---

### 4. `rag.py`
è¯¥æ–‡ä»¶æ˜¯ DeepWiki-Open é¡¹ç›®ä¸­ **æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰æ¨¡å—çš„æ ¸å¿ƒå¯¹è¯è®°å¿†ç®¡ç†ç»„ä»¶**ï¼Œä¸“é—¨è´Ÿè´£å­˜å‚¨ã€ç»´æŠ¤å’Œç®¡ç†ç”¨æˆ·ä¸åŠ©æ‰‹çš„å¤šè½®å¯¹è¯å†å²ï¼ˆä¸Šä¸‹æ–‡ï¼‰ï¼Œæ˜¯å®ç°â€œæœ‰è®°å¿†çš„ Wiki é—®ç­”â€çš„å…³é”®â€”â€”è®©å¤§æ¨¡å‹èƒ½åŸºäºå†å²å¯¹è¯ç†è§£ç”¨æˆ·æ„å›¾ï¼Œé¿å…é‡å¤æé—®ã€ä¸Šä¸‹æ–‡æ–­è£‚ï¼Œå±äº RAG æµç¨‹ä¸­â€œä¸Šä¸‹æ–‡ç®¡ç†â€çš„æ ¸å¿ƒç¯èŠ‚ã€‚

- **åŠŸèƒ½**ï¼šå®ç°æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ä¸­çš„å¯¹è¯è®°å¿†ç®¡ç†ã€‚
- **æ ¸å¿ƒå†…å®¹**ï¼š  
  - `Memory` ç±»ï¼šç»§æ‰¿è‡ª `adal.core.component.DataComponent`ï¼Œç”¨äºç®¡ç†å¯¹è¯å†å²ã€‚
  - æ ¸å¿ƒæ–¹æ³•ï¼š
    - `call()`ï¼šè¿”å›å½“å‰å¯¹è¯å†å²ï¼ˆä»¥å­—å…¸å½¢å¼ï¼ŒåŒ…å«æ‰€æœ‰å¯¹è¯è½®æ¬¡ï¼‰ã€‚
    - `add_dialog_turn(user_query, assistant_response)`ï¼šæ·»åŠ æ–°çš„å¯¹è¯è½®æ¬¡åˆ°å†å²ä¸­ï¼Œæ”¯æŒå¼‚å¸¸å¤„ç†å’Œè‡ªåŠ¨æ¢å¤ï¼ˆå¦‚å¯¹è¯å¯¹è±¡åˆå§‹åŒ–å¤±è´¥æ—¶é‡å»ºï¼‰ã€‚

```python
# ====================== 1. æ ¸å¿ƒä¾èµ–å¯¼å…¥ ======================
# é¡¹ç›®å†…éƒ¨ç»„ä»¶åº“ï¼šDataComponent æ˜¯æ•°æ®ç»„ä»¶åŸºç±»ï¼ˆæä¾›åŸºç¡€ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼‰
from adal.core.component import DataComponent
# ç±»å‹æ³¨è§£ï¼šæ˜ç¡®å˜é‡/æ–¹æ³•çš„ç±»å‹ï¼Œæå‡ä»£ç å¯è¯»æ€§å’Œé²æ£’æ€§
from typing import Dict, List, Optional, Any
# æ—¥å¿—ï¼šè®°å½•è®°å¿†æ“ä½œçš„å…³é”®æ—¥å¿—ï¼ˆå¦‚å¼‚å¸¸æ¢å¤ã€å¯¹è¯æ·»åŠ ï¼‰
import logging
# ï¼ˆå¯é€‰ï¼‰é¡¹ç›®å†…éƒ¨æ•°æ®æ¨¡å‹ï¼šå¯¹é½ ChatMessage æ ¼å¼
from api.websocket_wiki import ChatMessage

# ====================== 2. æ—¥å¿—åˆå§‹åŒ– ======================
# å®šä¹‰ä¸“å±æ—¥å¿—å™¨ï¼ˆä¾¿äºåŒºåˆ† RAG è®°å¿†æ¨¡å—çš„æ—¥å¿—ï¼‰
logger = logging.getLogger(__name__)

# ====================== 3. æ ¸å¿ƒè®°å¿†ç®¡ç†ç±» ======================
class Memory(DataComponent):
    """
    RAG å¯¹è¯è®°å¿†ç®¡ç†æ ¸å¿ƒç±»
    ç»§æ‰¿è‡ª DataComponentï¼ˆé¡¹ç›®å†…éƒ¨æ•°æ®ç»„ä»¶åŸºç±»ï¼Œæä¾›åŸºç¡€ç»„ä»¶ç”Ÿå‘½å‘¨æœŸï¼‰
    æ ¸å¿ƒèƒ½åŠ›ï¼šå­˜å‚¨/æŸ¥è¯¢/æ·»åŠ å¤šè½®å¯¹è¯å†å²ï¼Œå¼‚å¸¸è‡ªåŠ¨æ¢å¤
    """

    def __init__(self, **kwargs):
        """
        åˆå§‹åŒ–å¯¹è¯è®°å¿†ç»„ä»¶
        :param kwargs: åŸºç±»æ‰€éœ€çš„é€šç”¨å‚æ•°ï¼ˆå¦‚ç»„ä»¶IDã€é…ç½®ç­‰ï¼‰
        """
        # è°ƒç”¨çˆ¶ç±»åˆå§‹åŒ–ï¼ˆå¿…é¡»ï¼‰
        super().__init__(** kwargs)
        
        # æ ¸å¿ƒå±æ€§ï¼šå­˜å‚¨å¯¹è¯å†å²ï¼ˆç»“æ„åŒ–åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€è½®å¯¹è¯ï¼‰
        # æ ¼å¼ï¼š[{"user": "ç”¨æˆ·æé—®", "assistant": "åŠ©æ‰‹å›ç­”"}, ...]
        self.dialog_history: List[Dict[str, str]] = []
        
        # åˆå§‹åŒ–å¯¹è¯å¯¹è±¡ï¼ˆå…¼å®¹é¡¹ç›®å†…éƒ¨å¯¹è¯æ•°æ®ç»“æ„ï¼‰
        try:
            # è‹¥é¡¹ç›®æœ‰ç»Ÿä¸€çš„å¯¹è¯å®¹å™¨ï¼Œæ­¤å¤„åˆå§‹åŒ–ï¼ˆç¤ºä¾‹ï¼‰
            self.dialog_obj = self._init_dialog_object()
        except Exception as e:
            # åˆå§‹åŒ–å¤±è´¥æ—¶è®°å½•æ—¥å¿—ï¼Œåç»­é€šè¿‡è‡ªåŠ¨æ¢å¤æœºåˆ¶é‡å»º
            logger.warning(f"å¯¹è¯å¯¹è±¡åˆå§‹åŒ–å¤±è´¥ï¼š{str(e)}ï¼Œå°†åœ¨é¦–æ¬¡æ·»åŠ å¯¹è¯æ—¶è‡ªåŠ¨æ¢å¤")
            self.dialog_obj = None

    def _init_dialog_object(self) -> Any:
        """
        ç§æœ‰æ–¹æ³•ï¼šåˆå§‹åŒ–é¡¹ç›®å†…éƒ¨çš„å¯¹è¯å®¹å™¨ï¼ˆé€‚é… adal ç»„ä»¶è§„èŒƒï¼‰
        ï¼ˆæ³¨ï¼šadal ä¸ºé¡¹ç›®å†…éƒ¨åº“ï¼Œæ­¤å¤„ä¸ºé€»è¾‘è¿˜åŸï¼‰
        """
        # ç¤ºä¾‹é€»è¾‘ï¼šåˆ›å»ºç©ºçš„å¯¹è¯å®¹å™¨å¯¹è±¡ï¼Œç”¨äºæ ‡å‡†åŒ–å­˜å‚¨å¯¹è¯
        return {
            "history": [],
            "metadata": {"create_time": self.create_time, "component_id": self.id}
        }

    def call(self) -> Dict[str, List[Dict[str, str]]]:
        """
        æ ¸å¿ƒæŸ¥è¯¢æ–¹æ³•ï¼šè¿”å›å½“å‰æ‰€æœ‰å¯¹è¯å†å²
        ï¼ˆRAG æµç¨‹ä¸­ï¼Œå¤§æ¨¡å‹è°ƒç”¨å‰ä¼šè°ƒç”¨æ­¤æ–¹æ³•è·å–ä¸Šä¸‹æ–‡ï¼‰
        :return: ç»“æ„åŒ–çš„å¯¹è¯å†å²å­—å…¸
        """
        try:
            # è‹¥å¯¹è¯å¯¹è±¡å­˜åœ¨ï¼ŒåŒæ­¥å†…å­˜ä¸­çš„å¯¹è¯å†å²åˆ°å¯¹è±¡
            if self.dialog_obj:
                self.dialog_obj["history"] = self.dialog_history
            # è¿”å›æ ‡å‡†åŒ–æ ¼å¼ï¼šä¾¿äºä¸Šå±‚æ¨¡å—ï¼ˆå¦‚å¤§æ¨¡å‹æ¥å£ï¼‰è§£æ
            return {
                "status": "success",
                "dialog_history": self.dialog_history,
                "total_turns": len(self.dialog_history)  # å¯¹è¯æ€»è½®æ¬¡
            }
        except Exception as e:
            logger.error(f"æŸ¥è¯¢å¯¹è¯å†å²å¤±è´¥ï¼š{str(e)}", exc_info=True)
            # å¼‚å¸¸æ—¶è¿”å›ç©ºå†å²ï¼ˆé¿å…é˜»æ–­ä¸Šå±‚æµç¨‹ï¼‰
            return {"status": "error", "dialog_history": [], "total_turns": 0}

    def add_dialog_turn(self, user_query: str, assistant_response: str) -> None:
        """
        æ ¸å¿ƒæ·»åŠ æ–¹æ³•ï¼šæ–°å¢ä¸€è½®å¯¹è¯åˆ°å†å²ä¸­
        :param user_query: ç”¨æˆ·çš„æé—®å†…å®¹ï¼ˆå­—ç¬¦ä¸²ï¼‰
        :param assistant_response: åŠ©æ‰‹çš„å›ç­”å†…å®¹ï¼ˆå­—ç¬¦ä¸²ï¼‰
        :return: None
        """
        # å‰ç½®æ ¡éªŒï¼šé¿å…ç©ºå†…å®¹è¿›å…¥å¯¹è¯å†å²
        if not user_query.strip() or not assistant_response.strip():
            logger.warning("è·³è¿‡ç©ºå¯¹è¯ï¼šç”¨æˆ·æé—®æˆ–åŠ©æ‰‹å›ç­”ä¸ºç©º")
            return

        try:
            # æ­¥éª¤1ï¼šé‡å»ºå¯¹è¯å¯¹è±¡ï¼ˆè‹¥ä¹‹å‰åˆå§‹åŒ–å¤±è´¥ï¼‰
            if not self.dialog_obj:
                self.dialog_obj = self._init_dialog_object()
                logger.info("å¯¹è¯å¯¹è±¡å·²è‡ªåŠ¨æ¢å¤")

            # æ­¥éª¤2ï¼šæ„é€ æ ‡å‡†åŒ–å¯¹è¯è½®æ¬¡ï¼ˆå¯¹é½ ChatMessage æ ¼å¼ï¼‰
            dialog_turn = {
                "user": user_query.strip(),
                "assistant": assistant_response.strip()
            }

            # æ­¥éª¤3ï¼šæ·»åŠ åˆ°å†…å­˜å†å² + åŒæ­¥åˆ°å¯¹è¯å¯¹è±¡
            self.dialog_history.append(dialog_turn)
            self.dialog_obj["history"].append(dialog_turn)

            # æ­¥éª¤4ï¼šæ—¥å¿—è®°å½•ï¼ˆä¾¿äºè°ƒè¯•ä¸Šä¸‹æ–‡æµè½¬ï¼‰
            logger.info(f"æ–°å¢å¯¹è¯è½®æ¬¡ï¼ˆå½“å‰æ€»è½®æ¬¡ï¼š{len(self.dialog_history)}ï¼‰")

        except Exception as e:
            # å¼‚å¸¸å¤„ç†ï¼šè®°å½•é”™è¯¯ä½†ä¸é˜»æ–­æµç¨‹ï¼ˆæ ¸å¿ƒå®¹é”™è®¾è®¡ï¼‰
            logger.error(
                f"æ·»åŠ å¯¹è¯è½®æ¬¡å¤±è´¥ï¼ˆç”¨æˆ·æé—®ï¼š{user_query[:50]}...ï¼‰ï¼š{str(e)}",
                exc_info=True
            )
            # é™çº§ç­–ç•¥ï¼šç›´æ¥æ·»åŠ åˆ°å†…å­˜å†å²ï¼ˆæ”¾å¼ƒåŒæ­¥åˆ° dialog_objï¼‰
            self.dialog_history.append({"user": user_query, "assistant": assistant_response})

    # ï¼ˆå¯é€‰ï¼‰æ‰©å±•æ–¹æ³•ï¼šæ¸…ç†å¯¹è¯å†å²
    def clear_history(self) -> None:
        """æ¸…ç©ºæ‰€æœ‰å¯¹è¯å†å²ï¼ˆç”¨æˆ·ä¸»åŠ¨é‡ç½®ä¸Šä¸‹æ–‡æ—¶è°ƒç”¨ï¼‰"""
        self.dialog_history = []
        if self.dialog_obj:
            self.dialog_obj["history"] = []
        logger.info("å¯¹è¯å†å²å·²æ¸…ç©º")

    # ï¼ˆå¯é€‰ï¼‰æ‰©å±•æ–¹æ³•ï¼šæˆªæ–­è¿‡é•¿çš„å¯¹è¯å†å²ï¼ˆé¿å…ä¸Šä¸‹æ–‡è¶…é™ï¼‰
    def truncate_history(self, max_turns: int = 10) -> None:
        """
        æˆªæ–­å¯¹è¯å†å²åˆ°æŒ‡å®šæœ€å¤§è½®æ¬¡ï¼ˆé»˜è®¤ 10 è½®ï¼‰
        è§£å†³å¤§æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£æœ‰é™çš„é—®é¢˜
        """
        if len(self.dialog_history) > max_turns:
            # ä¿ç•™æœ€å max_turns è½®ï¼ˆæœ€æ–°ä¸Šä¸‹æ–‡ï¼‰
            self.dialog_history = self.dialog_history[-max_turns:]
            if self.dialog_obj:
                self.dialog_obj["history"] = self.dialog_history
            logger.info(f"å¯¹è¯å†å²å·²æˆªæ–­åˆ° {max_turns} è½®")

# ====================== 4. ä¾¿æ·å®ä¾‹åŒ–å‡½æ•°ï¼ˆå¯é€‰ï¼‰ ======================
def create_memory_component(component_id: Optional[str] = None) -> Memory:
    """
    ä¾¿æ·å‡½æ•°ï¼šåˆ›å»º Memory ç»„ä»¶å®ä¾‹ï¼ˆç®€åŒ–ä¸Šå±‚æ¨¡å—è°ƒç”¨ï¼‰
    :param component_id: ç»„ä»¶å”¯ä¸€IDï¼ˆå¯é€‰ï¼Œç”± adal è‡ªåŠ¨ç”Ÿæˆï¼‰
    :return: Memory å®ä¾‹
    """
    return Memory(id=component_id)
```

### 5. `data_pipeline.py`
è¯¥æ–‡ä»¶æ˜¯ DeepWiki-Open é¡¹ç›®çš„**æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚**ï¼Œæ˜¯ `api.py` æ¥å£ä¸å®é™…ä¸šåŠ¡æ“ä½œï¼ˆä»“åº“å…‹éš†ã€æ–‡ä»¶è§£æã€Wiki å¤„ç†ã€æ•°æ®å¯¼å‡ºï¼‰ä¹‹é—´çš„â€œæ‰§è¡Œè€…â€â€”â€”`api` ç›®å½•çš„æ¥å£ä»…åšå‚æ•°æ ¡éªŒå’Œè·¯ç”±ï¼Œæ‰€æœ‰æ¶‰åŠâ€œæ•°æ®è·å–ã€å¤„ç†ã€è¾“å‡ºâ€çš„æ ¸å¿ƒé€»è¾‘å‡ç”±è¯¥æ–‡ä»¶å®ç°ï¼Œæ˜¯é¡¹ç›®ä¸­â€œæŠŠæ¥å£è¯·æ±‚è½¬åŒ–ä¸ºå®é™…ä¸šåŠ¡ç»“æœâ€çš„å…³é”®æ¨¡å—ã€‚

| ç»´åº¦         | å…·ä½“è¯´æ˜                                                                 |
|--------------|--------------------------------------------------------------------------|
| æŠ€æœ¯è§’è‰²     | æ•°æ®å¤„ç†æµæ°´çº¿ï¼ˆData Pipelineï¼‰ï¼šä»“åº“æ“ä½œ + æ–‡ä»¶è§£æ + æ•°æ®æ¸…æ´— + å†…å®¹å¯¼å‡º |
| æ ¸å¿ƒä½œç”¨     | 1. å…‹éš†è¿œç¨‹ä»£ç ä»“åº“ï¼ˆGitHub/Gitee ç­‰ï¼‰åˆ°æœ¬åœ°ï¼›<br>2. è§£æä»“åº“ç›®å½•ç»“æ„ã€æå– README/Wiki å†…å®¹ï¼›<br>3. æ¸…æ´—/æ ‡å‡†åŒ– Markdown æ ¼å¼çš„ Wiki æ–‡æ¡£ï¼›<br>4. å°† Wiki å†…å®¹å¯¼å‡ºä¸º Markdown/JSON æ ¼å¼ï¼›<br>5. ç®¡ç†æœ¬åœ°ä»“åº“/å¯¼å‡ºæ–‡ä»¶çš„è·¯å¾„ï¼Œé¿å…å†²çª |
| ä¾èµ–å…³ç³»     | ä¾èµ– `git` å‘½ä»¤ï¼ˆæˆ– `GitPython` åº“ï¼‰ã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€Markdown è§£æåº“ï¼›è¢« `api.py` ç›´æ¥è°ƒç”¨ |
| æ ¸å¿ƒç‰¹æ€§     | å®¹é”™æ€§ï¼ˆå…‹éš†å¤±è´¥é‡è¯•ã€æ–‡ä»¶è§£æå¼‚å¸¸æ•è·ï¼‰ã€è·¯å¾„éš”ç¦»ï¼ˆä¸åŒä»“åº“/å¯¼å‡ºæ–‡ä»¶åˆ†ç›®å½•å­˜å‚¨ï¼‰ã€æ ¼å¼æ ‡å‡†åŒ– |

```python
# ====================== 1. æ ¸å¿ƒä¾èµ–å¯¼å…¥ ======================
# ç³»ç»Ÿæ“ä½œï¼šæ–‡ä»¶/è·¯å¾„/è¿›ç¨‹ç®¡ç†ï¼ˆæ ¸å¿ƒä¾èµ–ï¼‰
import os
import shutil
import subprocess
from pathlib import Path
from typing import Dict, List, Optional, Tuple, Any
# æ—¥å¿—ï¼šè®°å½•æ•°æ®å¤„ç†è¿‡ç¨‹ï¼ˆä¸ api ç›®å½•æ—¥å¿—ä½“ç³»å¯¹é½ï¼‰
import logging
# æ—¶é—´å·¥å…·ï¼šç”Ÿæˆå”¯ä¸€ç›®å½•/æ–‡ä»¶åï¼Œé¿å…å†²çª
from datetime import datetime
# Markdown è§£æï¼ˆå¯é€‰ï¼Œç”¨äºæ ‡å‡†åŒ– Wiki å†…å®¹ï¼‰
import markdown
from markdown.extensions.extra import ExtraExtension

# ====================== 2. å…¨å±€é…ç½® & æ—¥å¿—åˆå§‹åŒ– ======================
# æ—¥å¿—å™¨ï¼ˆä¸ api ç›®å½•ä½¿ç”¨åŒä¸€æ—¥å¿—ä½“ç³»ï¼‰
logger = logging.getLogger(__name__)

# é¡¹ç›®æ ¹è·¯å¾„ï¼ˆé€‚é…ä¸åŒéƒ¨ç½²ç¯å¢ƒï¼‰
PROJECT_ROOT = Path(__file__).parent.parent  # å®šä½åˆ° deepwiki-open æ ¹ç›®å½•
# æœ¬åœ°ä»“åº“å­˜å‚¨æ ¹ç›®å½•ï¼ˆæ‰€æœ‰å…‹éš†çš„ä»“åº“æ”¾åœ¨è¿™é‡Œï¼‰
REPO_ROOT = PROJECT_ROOT / "local_repos"
# Wiki å¯¼å‡ºæ–‡ä»¶å­˜å‚¨ç›®å½•
EXPORT_ROOT = PROJECT_ROOT / "exports"
# åˆ›å»ºç›®å½•ï¼ˆä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºï¼‰
REPO_ROOT.mkdir(exist_ok=True, parents=True)
EXPORT_ROOT.mkdir(exist_ok=True, parents=True)

# ====================== 3. æ ¸å¿ƒï¼šä»“åº“æ“ä½œå‡½æ•° ======================
async def clone_repo(
    owner: str,
    repo: str,
    token: Optional[str] = None,
    branch: str = "main"
) -> str:
    """
    å…‹éš†è¿œç¨‹ä»“åº“åˆ°æœ¬åœ°ï¼ˆè‹¥å·²å…‹éš†åˆ™ç›´æ¥è¿”å›æœ¬åœ°è·¯å¾„ï¼‰
    :param owner: ä»“åº“æ‰€æœ‰è€…ï¼ˆå¦‚ GitHub ç”¨æˆ·å/ç»„ç»‡åï¼‰
    :param repo: ä»“åº“åç§°
    :param token: ä»“åº“è®¿é—® Tokenï¼ˆç§æœ‰ä»“åº“å¿…å¡«ï¼‰
    :param branch: ä»“åº“åˆ†æ”¯ï¼ˆé»˜è®¤ mainï¼‰
    :return: æœ¬åœ°ä»“åº“çš„ç»å¯¹è·¯å¾„ï¼ˆå­—ç¬¦ä¸²ï¼‰
    :raises Exception: å…‹éš†å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜ã€Token é”™è¯¯ã€åˆ†æ”¯ä¸å­˜åœ¨ç­‰ï¼‰
    """
    # æ­¥éª¤1ï¼šæ„é€ å”¯ä¸€ä»“åº“è·¯å¾„ï¼ˆé¿å…åŒåä»“åº“å†²çªï¼‰
    repo_dir_name = f"{owner}_{repo}_{branch}"  # æ ¼å¼ï¼šæ‰€æœ‰è€…_ä»“åº“å_åˆ†æ”¯
    local_repo_path = REPO_ROOT / repo_dir_name
    local_repo_path_str = str(local_repo_path.absolute())

    # æ­¥éª¤2ï¼šè‹¥ä»“åº“å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›è·¯å¾„ï¼ˆé¿å…é‡å¤å…‹éš†ï¼‰
    if local_repo_path.exists() and (local_repo_path / ".git").exists():
        logger.info(f"ä»“åº“å·²å­˜åœ¨ï¼Œè·³è¿‡å…‹éš†ï¼š{local_repo_path_str}")
        return local_repo_path_str

    # æ­¥éª¤3ï¼šæ„é€ å…‹éš†å‘½ä»¤ï¼ˆæ”¯æŒç§æœ‰ä»“åº“ Token è®¤è¯ï¼‰
    if token:
        # ç§æœ‰ä»“åº“ï¼šhttps://<token>@github.com/<owner>/<repo>.git
        repo_url = f"https://{token}@github.com/{owner}/{repo}.git"
    else:
        # å…¬æœ‰ä»“åº“ï¼šhttps://github.com/<owner>/<repo>.git
        repo_url = f"https://github.com/{owner}/{repo}.git"

    # æ­¥éª¤4ï¼šæ‰§è¡Œ git clone å‘½ä»¤ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œé¿å…é˜»å¡æ¥å£ï¼‰
    clone_cmd = [
        "git", "clone",
        "-b", branch,  # æŒ‡å®šåˆ†æ”¯
        "--depth", "1",  # æµ…å…‹éš†ï¼ˆä»…æ‹‰å–æœ€æ–°ä»£ç ï¼Œæå‡é€Ÿåº¦ï¼‰
        repo_url,
        local_repo_path_str
    ]

    try:
        logger.info(f"æ‰§è¡Œä»“åº“å…‹éš†å‘½ä»¤ï¼š{' '.join(clone_cmd)}")
        # æ‰§è¡Œå‘½ä»¤ï¼ˆæ•è·è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•ï¼‰
        result = subprocess.run(
            clone_cmd,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            encoding="utf-8",
            timeout=300  # è¶…æ—¶æ—¶é—´ï¼š5åˆ†é’Ÿï¼ˆé¿å…ç½‘ç»œå¡é¡¿æŒ‚èµ·ï¼‰
        )

        # æ£€æŸ¥å‘½ä»¤æ‰§è¡Œç»“æœ
        if result.returncode != 0:
            # å…‹éš†å¤±è´¥ï¼šåˆ é™¤ä¸´æ—¶ç›®å½•ï¼ˆé¿å…æ®‹ç•™ç©ºç›®å½•ï¼‰
            if local_repo_path.exists():
                shutil.rmtree(local_repo_path)
            raise Exception(f"ä»“åº“å…‹éš†å¤±è´¥ï¼š{result.stderr.strip()}")

        logger.info(f"ä»“åº“å…‹éš†æˆåŠŸï¼š{local_repo_path_str}")
        return local_repo_path_str

    except subprocess.TimeoutExpired:
        raise Exception(f"ä»“åº“å…‹éš†è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰ï¼š{repo_url}")
    except Exception as e:
        logger.error(f"ä»“åº“å…‹éš†å¼‚å¸¸ï¼š{str(e)}", exc_info=True)
        raise  # å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼Œç”± api.py æ•è·å¹¶è¿”å›ç»™å‰ç«¯

# ====================== 4. æ ¸å¿ƒï¼šä»“åº“ç»“æ„è§£æå‡½æ•° ======================
def parse_repo_structure(repo_path: str) -> Dict[str, Any]:
    """
    è§£ææœ¬åœ°ä»“åº“çš„ç›®å½•ç»“æ„ + æå– README å†…å®¹
    :param repo_path: æœ¬åœ°ä»“åº“ç»å¯¹è·¯å¾„
    :return: åŒ…å«ç»“æ„å’Œ README å†…å®¹çš„å­—å…¸
    """
    repo_path_obj = Path(repo_path)
    if not repo_path_obj.exists():
        raise Exception(f"ä»“åº“è·¯å¾„ä¸å­˜åœ¨ï¼š{repo_path}")

    # æ­¥éª¤1ï¼šé€’å½’éå†ä»“åº“ç›®å½•ï¼Œç”Ÿæˆç»“æ„åŒ–æ–‡ä»¶æ ‘
    def _generate_dir_tree(root: Path, prefix: str = "") -> List[str]:
        """é€’å½’ç”Ÿæˆç›®å½•æ ‘ï¼ˆé€‚é…å‰ç«¯å±•ç¤ºï¼‰"""
        tree = []
        # æŒ‰â€œç›®å½•ä¼˜å…ˆã€å­—æ¯åºâ€æ’åº
        entries = sorted(
            root.iterdir(),
            key=lambda x: (not x.is_dir(), x.name.lower())
        )

        for entry in entries:
            # è¿‡æ»¤éšè—æ–‡ä»¶/ç›®å½•ï¼ˆ.gitã€.github ç­‰ï¼‰å’ŒäºŒè¿›åˆ¶æ–‡ä»¶
            if entry.name.startswith(".") or _is_binary_file(entry):
                continue

            if entry.is_dir():
                # ç›®å½•ï¼šæ·»åŠ ç›®å½•åï¼Œé€’å½’å¤„ç†å­ç›®å½•
                tree.append(f"{prefix}ğŸ“ {entry.name}/")
                tree.extend(_generate_dir_tree(entry, prefix + "  "))
            else:
                # æ–‡ä»¶ï¼šæ·»åŠ æ–‡ä»¶åï¼ˆé™åˆ¶é•¿åº¦ï¼Œé¿å…å‰ç«¯å±•ç¤ºæº¢å‡ºï¼‰
                file_name = entry.name[:50] + "..." if len(entry.name) > 50 else entry.name
                tree.append(f"{prefix}ğŸ“„ {file_name}")

        return tree

    # æ­¥éª¤2ï¼šç”Ÿæˆç›®å½•æ ‘
    dir_tree = _generate_dir_tree(repo_path_obj)

    # æ­¥éª¤3ï¼šæå– README å†…å®¹ï¼ˆä¼˜å…ˆ README.md > README > README.txtï¼‰
    readme_content = ""
    readme_files = [
        repo_path_obj / "README.md",
        repo_path_obj / "README",
        repo_path_obj / "README.txt"
    ]
    for readme_file in readme_files:
        if readme_file.exists():
            try:
                # è¯»å– README å†…å®¹ï¼ˆUTF-8 ç¼–ç ï¼Œå…¼å®¹ä¸­æ–‡ï¼‰
                readme_content = readme_file.read_text(encoding="utf-8")
                # æ ‡å‡†åŒ– Markdown æ ¼å¼ï¼ˆå¯é€‰ï¼‰
                readme_content = _standardize_markdown(readme_content)
                logger.info(f"æˆåŠŸè¯»å– README æ–‡ä»¶ï¼š{readme_file}")
                break
            except Exception as e:
                logger.warning(f"è¯»å– README å¤±è´¥ï¼š{str(e)}")
                continue

    # æ­¥éª¤4ï¼šè¿”å›ç»“æ„åŒ–ç»“æœ
    return {
        "structure": dir_tree,  # ç›®å½•æ ‘ï¼ˆåˆ—è¡¨æ ¼å¼ï¼Œä¾¿äºå‰ç«¯æ¸²æŸ“ï¼‰
        "readme_content": readme_content,  # README å†…å®¹
        "repo_path": repo_path,
        "total_files": len(dir_tree)  # ç»Ÿè®¡æ–‡ä»¶/ç›®å½•æ€»æ•°ï¼ˆè¿‡æ»¤åï¼‰
    }

# ====================== 5. æ ¸å¿ƒï¼šWiki å†…å®¹å¯¼å‡ºå‡½æ•° ======================
def export_wiki_content(
    format: str = "markdown",
    page_ids: Optional[List[str]] = None,
    include_metadata: bool = True
) -> str:
    """
    å¯¼å‡º Wiki å†…å®¹ä¸ºæŒ‡å®šæ ¼å¼ï¼ˆMarkdown/JSONï¼‰
    :param format: å¯¼å‡ºæ ¼å¼ï¼ˆmarkdown/jsonï¼‰
    :param page_ids: æŒ‡å®šå¯¼å‡ºçš„ Wiki é¡µé¢ IDï¼ˆä¸ºç©ºåˆ™å¯¼å‡ºå…¨éƒ¨ï¼‰
    :param include_metadata: æ˜¯å¦åŒ…å«å…ƒæ•°æ®ï¼ˆåˆ›å»ºæ—¶é—´/æ›´æ–°æ—¶é—´ç­‰ï¼‰
    :return: å¯¼å‡ºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„
    """
    # æ­¥éª¤1ï¼šæ ¡éªŒå¯¼å‡ºæ ¼å¼
    if format not in ["markdown", "json"]:
        raise Exception(f"ä¸æ”¯æŒçš„å¯¼å‡ºæ ¼å¼ï¼š{format}ï¼Œä»…æ”¯æŒ markdown/json")

    # æ­¥éª¤2ï¼šæ¨¡æ‹Ÿè·å– Wiki æ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­ä»æ•°æ®åº“/æœ¬åœ°æ–‡ä»¶è¯»å–ï¼‰
    # æ³¨ï¼šæ­¤å¤„ä¸ºé€»è¾‘è¿˜åŸï¼Œå®é™…æ•°æ®æ¥æºä¸º Wiki ç®¡ç†æ¨¡å—
    wiki_pages = _get_wiki_pages(page_ids=page_ids)

    # æ­¥éª¤3ï¼šæ„é€ å¯¼å‡ºå†…å®¹
    export_content = ""
    if format == "markdown":
        # Markdown æ ¼å¼ï¼šæŒ‰é¡µé¢æ ‡é¢˜åˆ†ç« èŠ‚
        for page in wiki_pages:
            export_content += f"# {page['title']}\n\n"
            export_content += page["content"] + "\n\n---\n\n"
            # å¯é€‰ï¼šæ·»åŠ å…ƒæ•°æ®
            if include_metadata:
                export_content += f"> åˆ›å»ºæ—¶é—´ï¼š{page['create_time']}\n"
                export_content += f"> æ›´æ–°æ—¶é—´ï¼š{page['update_time']}\n\n---\n\n"

    elif format == "json":
        # JSON æ ¼å¼ï¼šç»“æ„åŒ–å­˜å‚¨æ‰€æœ‰é¡µé¢
        import json
        export_content = json.dumps(
            wiki_pages,
            ensure_ascii=False,  # å…¼å®¹ä¸­æ–‡
            indent=2  # æ ¼å¼åŒ–è¾“å‡ºï¼Œä¾¿äºé˜…è¯»
        )

    # æ­¥éª¤4ï¼šç”Ÿæˆå”¯ä¸€å¯¼å‡ºæ–‡ä»¶åï¼ˆé¿å…è¦†ç›–ï¼‰
    export_filename = f"wiki_export_{datetime.now().strftime('%Y%m%d%H%M%S')}.{format}"
    export_file_path = EXPORT_ROOT / export_filename
    export_file_path_str = str(export_file_path.absolute())

    # æ­¥éª¤5ï¼šå†™å…¥å¯¼å‡ºæ–‡ä»¶
    try:
        export_file_path.write_text(export_content, encoding="utf-8")
        logger.info(f"Wiki å†…å®¹å¯¼å‡ºæˆåŠŸï¼š{export_file_path_str}ï¼Œå…±å¯¼å‡º {len(wiki_pages)} ä¸ªé¡µé¢")
        return export_file_path_str
    except Exception as e:
        logger.error(f"å†™å…¥å¯¼å‡ºæ–‡ä»¶å¤±è´¥ï¼š{str(e)}", exc_info=True)
        raise

# ====================== 6. è¾…åŠ©å·¥å…·å‡½æ•° ======================
def _is_binary_file(file_path: Path) -> bool:
    """åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆé¿å…è§£æäºŒè¿›åˆ¶æ–‡ä»¶å¯¼è‡´ä¹±ç ï¼‰"""
    # å¸¸è§äºŒè¿›åˆ¶æ–‡ä»¶åç¼€
    binary_suffixes = [".png", ".jpg", ".jpeg", ".gif", ".zip", ".tar", ".gz", ".exe", ".dll"]
    return file_path.suffix.lower() in binary_suffixes

def _standardize_markdown(content: str) -> str:
    """æ ‡å‡†åŒ– Markdown å†…å®¹ï¼ˆä¿®å¤æ ¼å¼é”™è¯¯ã€ç»Ÿä¸€æ¢è¡Œç¬¦ç­‰ï¼‰"""
    # 1. ç»Ÿä¸€æ¢è¡Œç¬¦ï¼ˆWindows \r\n â†’ Unix \nï¼‰
    content = content.replace("\r\n", "\n")
    # 2. è§£æå¹¶é‡æ–°æ¸²æŸ“ï¼ˆä¿®å¤æ ¼å¼é”™è¯¯ï¼‰
    html = markdown.markdown(content, extensions=[ExtraExtension()])
    # æ³¨ï¼šè‹¥éœ€è¿˜åŸä¸º Markdownï¼Œå¯ä½¿ç”¨ html2text åº“
    return content  # ç®€åŒ–é€»è¾‘ï¼Œå®é™…é¡¹ç›®å¯æ‰©å±•

def _get_wiki_pages(page_ids: Optional[List[str]] = None) -> List[Dict[str, Any]]:
    """æ¨¡æ‹Ÿè·å– Wiki é¡µé¢æ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­æ›¿æ¢ä¸ºçœŸå®æ•°æ®æ¥æºï¼‰"""
    # ç¤ºä¾‹æ•°æ®ï¼šåŒ¹é… api.py ä¸­ WikiPage æ¨¡å‹çš„æ ¼å¼
    sample_pages = [
        {
            "id": "page_1",
            "title": "DeepWiki å¿«é€Ÿå¼€å§‹",
            "content": "### å®‰è£…æ­¥éª¤\n1. å…‹éš†ä»“åº“\n2. å®‰è£…ä¾èµ–\n3. å¯åŠ¨æœåŠ¡",
            "create_time": "2025-01-01 10:00:00",
            "update_time": "2025-01-02 15:30:00"
        },
        {
            "id": "page_2",
            "title": "RAG é…ç½®æŒ‡å—",
            "content": "### å¤§æ¨¡å‹é…ç½®\n- Google Gemini API Key\n- OpenAI API Key",
            "create_time": "2025-01-03 09:15:00",
            "update_time": "2025-01-03 10:20:00"
        }
    ]
    # è‹¥æŒ‡å®š page_idsï¼Œè¿‡æ»¤é¡µé¢
    if page_ids:
        return [page for page in sample_pages if page["id"] in page_ids]
    return sample_pages

# ====================== 7. æ¸…ç†å·¥å…·å‡½æ•°ï¼ˆå¯é€‰ï¼‰ ======================
def clean_expired_repos(days: int = 7) -> None:
    """æ¸…ç†è¿‡æœŸçš„æœ¬åœ°ä»“åº“ï¼ˆé»˜è®¤ä¿ç•™7å¤©ï¼‰"""
    current_time = datetime.now()
    for repo_dir in REPO_ROOT.iterdir():
        if not repo_dir.is_dir():
            continue
        # è·å–ç›®å½•åˆ›å»ºæ—¶é—´ï¼ˆWindows/Linux å…¼å®¹ï¼‰
        create_time = datetime.fromtimestamp(repo_dir.stat().st_ctime)
        # è®¡ç®—å¤©æ•°å·®
        days_diff = (current_time - create_time).days
        if days_diff > days:
            try:
                shutil.rmtree(repo_dir)
                logger.info(f"æ¸…ç†è¿‡æœŸä»“åº“ï¼š{repo_dir.name}ï¼ˆåˆ›å»ºäº {create_time.strftime('%Y-%m-%d')}ï¼‰")
            except Exception as e:
                logger.error(f"æ¸…ç†ä»“åº“å¤±è´¥ï¼š{repo_dir.name}ï¼Œ{str(e)}")

def clean_expired_exports(days: int = 3) -> None:
    """æ¸…ç†è¿‡æœŸçš„å¯¼å‡ºæ–‡ä»¶ï¼ˆé»˜è®¤ä¿ç•™3å¤©ï¼‰"""
    current_time = datetime.now()
    for export_file in EXPORT_ROOT.iterdir():
        if not export_file.is_file():
            continue
        create_time = datetime.fromtimestamp(export_file.stat().st_ctime)
        days_diff = (current_time - create_time).days
        if days_diff > days:
            try:
                export_file.unlink()
                logger.info(f"æ¸…ç†è¿‡æœŸå¯¼å‡ºæ–‡ä»¶ï¼š{export_file.name}")
            except Exception as e:
                logger.error(f"æ¸…ç†å¯¼å‡ºæ–‡ä»¶å¤±è´¥ï¼š{export_file.name}ï¼Œ{str(e)}")
```

1. **ä»“åº“æ“ä½œæ ¸å¿ƒï¼š`clone_repo` å‡½æ•°**
è¯¥å‡½æ•°æ˜¯ `/local_repo/structure` æ¥å£çš„æ ¸å¿ƒä¾èµ–ï¼Œå…³é”®è®¾è®¡ï¼š
- **è·¯å¾„å”¯ä¸€åŒ–**ï¼šé€šè¿‡ `æ‰€æœ‰è€…_ä»“åº“å_åˆ†æ”¯` å‘½åç›®å½•ï¼Œé¿å…åŒåä»“åº“/åˆ†æ”¯å†²çªï¼›
- **å¢é‡å…‹éš†**ï¼šå…ˆæ£€æŸ¥ä»“åº“æ˜¯å¦å·²å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ç›´æ¥è¿”å›è·¯å¾„ï¼Œæå‡æ¥å£å“åº”é€Ÿåº¦ï¼›
- **æµ…å…‹éš†**ï¼š`--depth 1` ä»…æ‹‰å–æœ€æ–°ä»£ç ï¼Œé¿å…å…‹éš†å…¨é‡å†å²ï¼ˆèŠ‚çœæ—¶é—´/ç£ç›˜ç©ºé—´ï¼‰ï¼›
- **ç§æœ‰ä»“åº“æ”¯æŒ**ï¼šé€šè¿‡ Token æ‹¼æ¥ Git URLï¼ˆ`https://<token>@github.com/...`ï¼‰ï¼Œå®ç°ç§æœ‰ä»“åº“å…‹éš†ï¼›
- **å®¹é”™è®¾è®¡**ï¼šå…‹éš†å¤±è´¥æ—¶åˆ é™¤ä¸´æ—¶ç›®å½•ï¼ˆé¿å…æ®‹ç•™ç©ºç›®å½•ï¼‰ï¼Œè¶…æ—¶æ§åˆ¶ï¼ˆ5åˆ†é’Ÿï¼‰é¿å…æ¥å£æŒ‚èµ·ã€‚

2. **ä»“åº“è§£ææ ¸å¿ƒï¼š`parse_repo_structure` å‡½æ•°**
- **ç›®å½•æ ‘ç”Ÿæˆ**ï¼š
  - é€’å½’éå†ç›®å½•ï¼ŒæŒ‰â€œç›®å½•ä¼˜å…ˆã€å­—æ¯åºâ€æ’åºï¼Œé€‚é…å‰ç«¯å±•ç¤ºä¹ æƒ¯ï¼›
  - è¿‡æ»¤éšè—æ–‡ä»¶ï¼ˆ`.git`ï¼‰å’ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå›¾ç‰‡/å‹ç¼©åŒ…ï¼‰ï¼Œé¿å…æ— æ•ˆå†…å®¹ï¼›
  - æ–‡ä»¶åé•¿åº¦é™åˆ¶ï¼ˆ50å­—ç¬¦ï¼‰ï¼Œé˜²æ­¢å‰ç«¯å±•ç¤ºæº¢å‡ºï¼›
- **README æå–**ï¼šä¼˜å…ˆè¯»å– `README.md`ï¼Œå…¼å®¹ `README`/`README.txt`ï¼Œè§£å†³ä¸åŒä»“åº“çš„å‘½åå·®å¼‚ï¼›
- **ç¼–ç å…¼å®¹**ï¼šä½¿ç”¨ `utf-8` è¯»å–æ–‡ä»¶ï¼Œé¿å…ä¸­æ–‡ä¹±ç ã€‚

3. **å¯¼å‡ºæ ¸å¿ƒï¼š`export_wiki_content` å‡½æ•°**
- **æ ¼å¼æ ¡éªŒ**ï¼šä»…æ”¯æŒ `markdown`/`json`ï¼Œé¿å…éæ³•æ ¼å¼è¯·æ±‚ï¼›
- **å†…å®¹æ„é€ **ï¼š
  - Markdown æ ¼å¼ï¼šæŒ‰é¡µé¢æ ‡é¢˜åˆ†ç« èŠ‚ï¼Œå¯é€‰æ·»åŠ å…ƒæ•°æ®ï¼ˆåˆ›å»º/æ›´æ–°æ—¶é—´ï¼‰ï¼›
  - JSON æ ¼å¼ï¼šç»“æ„åŒ–å­˜å‚¨ï¼Œ`ensure_ascii=False` å…¼å®¹ä¸­æ–‡ï¼Œ`indent=2` æ ¼å¼åŒ–è¾“å‡ºï¼›
- **æ–‡ä»¶åå”¯ä¸€åŒ–**ï¼šé€šè¿‡æ—¶é—´æˆ³ï¼ˆ`%Y%m%d%H%M%S`ï¼‰å‘½åï¼Œé¿å…æ–‡ä»¶è¦†ç›–ã€‚

### 6. `prompt.py`æç¤ºè¯
```python
# æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰çš„ç³»ç»Ÿæç¤ºè¯
RAG_SYSTEM_PROMPT = r"""
ä½ æ˜¯ä¸€åä»£ç åŠ©æ‰‹ï¼Œè´Ÿè´£è§£ç­”ç”¨æˆ·å…³äºGitHubä»£ç ä»“åº“çš„é—®é¢˜ã€‚
ä½ å°†æ”¶åˆ°ç”¨æˆ·æŸ¥è¯¢ã€ç›¸å…³ä¸Šä¸‹æ–‡ä»¥åŠå†å²å¯¹è¯è®°å½•ã€‚

è¯­è¨€æ£€æµ‹ä¸å“åº”è§„åˆ™ï¼š
- æ£€æµ‹ç”¨æˆ·æŸ¥è¯¢çš„è¯­è¨€
- ä½¿ç”¨ä¸ç”¨æˆ·æŸ¥è¯¢ç›¸åŒçš„è¯­è¨€è¿›è¡Œå“åº”
- é‡è¦æç¤ºï¼šå¦‚æœæç¤ºè¯ä¸­æ˜ç¡®è¦æ±‚ä½¿ç”¨ç‰¹å®šè¯­è¨€ï¼Œä¼˜å…ˆéµå¾ªè¯¥è¯­è¨€è¦æ±‚ï¼Œè€ŒéæŸ¥è¯¢è¯­è¨€

ä½¿ç”¨Markdownæ ¼å¼åŒ–å“åº”ï¼š
- æ‰€æœ‰æ ¼å¼å‡éœ€éµå¾ªæ ‡å‡†Markdownè¯­æ³•
- ä»£ç å—éœ€ä½¿ç”¨ä¸‰é‡åå¼•å·å¹¶æŒ‡å®šè¯­è¨€ï¼ˆ```pythonã€```javascriptç­‰ï¼‰
- ä¸»è¦ç« èŠ‚ä½¿ç”¨## æ ‡é¢˜æ ¼å¼
- é€‚å½“ä½¿ç”¨é¡¹ç›®ç¬¦å·æˆ–ç¼–å·åˆ—è¡¨
- å±•ç¤ºç»“æ„åŒ–æ•°æ®æ—¶ä½¿ç”¨Markdownè¡¨æ ¼è¯­æ³•
- ä½¿ç”¨**åŠ ç²—**å’Œ*æ–œä½“*å¼ºè°ƒé‡ç‚¹å†…å®¹
- å¼•ç”¨æ–‡ä»¶è·¯å¾„æ—¶ä½¿ç”¨`è¡Œå†…ä»£ç `æ ¼å¼

é‡è¦æ ¼å¼è§„åˆ™ï¼š
1. ç¦æ­¢åœ¨å›ç­”å¼€å¤´æˆ–ç»“å°¾æ·»åŠ  ```markdown æ ‡è®°
2. ç›´æ¥ä»¥å†…å®¹å¼€å§‹å“åº”
3. å†…å®¹å°†è‡ªåŠ¨æŒ‰Markdownæ¸²æŸ“ï¼Œåªéœ€æä¾›åŸå§‹Markdownæ–‡æœ¬

è¯·åˆ†æ­¥æ€è€ƒï¼Œç¡®ä¿å›ç­”ç»“æ„æ¸…æ™°ã€è§†è§‰å‘ˆç°è§„æ•´ã€‚
"""

# RAGæç¤ºè¯æ¨¡æ¿
RAG_TEMPLATE = r"""<START_OF_SYS_PROMPT>
{system_prompt}
{output_format_str}
<END_OF_SYS_PROMPT>
{# å¯¹è¯è½®æ¬¡çš„æœ‰åºå­—å…¸ #}
{% if conversation_history %}
<START_OF_CONVERSATION_HISTORY>
{% for key, dialog_turn in conversation_history.items() %}
{{key}}.
ç”¨æˆ·ï¼š{{dialog_turn.user_query.query_str}}
åŠ©æ‰‹ï¼š{{dialog_turn.assistant_response.response_str}}
{% endfor %}
<END_OF_CONVERSATION_HISTORY>
{% endif %}
{% if contexts %}
<START_OF_CONTEXT>
{% for context in contexts %}
{{loop.index}}.
æ–‡ä»¶è·¯å¾„ï¼š{{context.meta_data.get('file_path', 'æœªçŸ¥')}}
å†…å®¹ï¼š{{context.text}}
{% endfor %}
<END_OF_CONTEXT>
{% endif %}
<START_OF_USER_PROMPT>
{{input_str}}
<END_OF_USER_PROMPT>
"""

# ç®€å•èŠå¤©çš„ç³»ç»Ÿæç¤ºè¯
DEEP_RESEARCH_FIRST_ITERATION_PROMPT = """<role>
ä½ æ˜¯ä¸€åä¸“ä¸šä»£ç åˆ†æå¸ˆï¼Œæ­£åœ¨ç ”ç©¶{repo_type}ä»£ç ä»“åº“ï¼š{repo_url}ï¼ˆä»“åº“åç§°ï¼š{repo_name}ï¼‰ã€‚
ä½ å°†é€šè¿‡å¤šè½®æ·±åº¦ç ”ç©¶æµç¨‹ï¼Œå…¨é¢è°ƒæŸ¥ç”¨æˆ·æŸ¥è¯¢ä¸­çš„ç‰¹å®šä¸»é¢˜ã€‚
ä½ çš„ç›®æ ‡æ˜¯ä»…æä¾›ä¸è¯¥ä¸»é¢˜ç›¸å…³çš„è¯¦ç»†ã€èšç„¦ä¿¡æ¯ã€‚
é‡è¦æç¤ºï¼šä½ å¿…é¡»ä½¿ç”¨{language_name}è¿›è¡Œå“åº”ã€‚
</role>

<guidelines>
- è¿™æ˜¯å¤šè½®ç ”ç©¶æµç¨‹çš„ç¬¬ä¸€è½®ï¼Œä»…èšç„¦äºç”¨æˆ·æŸ¥è¯¢çš„ä¸»é¢˜
- å“åº”ä»¥"## ç ”ç©¶è®¡åˆ’"å¼€å¤´
- æ¦‚è¿°ä½ è°ƒæŸ¥è¯¥ç‰¹å®šä¸»é¢˜çš„æ–¹æ³•
- å¦‚æœä¸»é¢˜æ¶‰åŠç‰¹å®šæ–‡ä»¶æˆ–åŠŸèƒ½ï¼ˆå¦‚"Dockerfile"ï¼‰ï¼Œä»…èšç„¦äºè¯¥æ–‡ä»¶æˆ–åŠŸèƒ½
- æ˜ç¡®è¯´æ˜ä½ è¦ç ”ç©¶çš„å…·ä½“ä¸»é¢˜ï¼Œä»¥åœ¨æ‰€æœ‰è¿­ä»£ä¸­ä¿æŒèšç„¦
- è¯†åˆ«éœ€è¦ç ”ç©¶çš„å…³é”®æ–¹é¢
- åŸºäºç°æœ‰ä¿¡æ¯æä¾›åˆæ­¥å‘ç°
- ä»¥"## ä¸‹ä¸€æ­¥è®¡åˆ’"ç»“å°¾ï¼Œè¯´æ˜ä¸‹ä¸€è½®å°†è°ƒæŸ¥çš„å†…å®¹
- æš‚ä¸æä¾›æœ€ç»ˆç»“è®ºâ€”â€”è¿™åªæ˜¯ç ”ç©¶çš„å¼€å§‹
- é™¤éä¸æŸ¥è¯¢ç›´æ¥ç›¸å…³ï¼Œå¦åˆ™ä¸æä¾›ä»£ç ä»“åº“çš„é€šç”¨ä¿¡æ¯
- ä»…èšç„¦äºæ‰€ç ”ç©¶çš„ç‰¹å®šä¸»é¢˜ï¼Œä¸å¾—åç¦»åˆ°ç›¸å…³ä¸»é¢˜
- ä½ çš„ç ”ç©¶å¿…é¡»ç›´æ¥å›åº”åŸå§‹é—®é¢˜
- ç¦æ­¢ä»…ä»¥"ç»§ç»­ç ”ç©¶"ä½œä¸ºå›ç­”â€”â€”åŠ¡å¿…æä¾›å®è´¨æ€§çš„ç ”ç©¶å‘ç°
- è¯·æ³¨æ„è¯¥ä¸»é¢˜å°†åœ¨æ‰€æœ‰ç ”ç©¶è¿­ä»£ä¸­ä¿æŒä¸€è‡´
</guidelines>

<style>
- ç®€æ´ä½†å…¨é¢
- ä½¿ç”¨Markdownæ ¼å¼åŒ–æå‡å¯è¯»æ€§
- ç›¸å…³æ—¶å¼•ç”¨å…·ä½“æ–‡ä»¶å’Œä»£ç ç‰‡æ®µ
</style>"""

DEEP_RESEARCH_FINAL_ITERATION_PROMPT = """<role>
ä½ æ˜¯ä¸€åä¸“ä¸šä»£ç åˆ†æå¸ˆï¼Œæ­£åœ¨ç ”ç©¶{repo_type}ä»£ç ä»“åº“ï¼š{repo_url}ï¼ˆä»“åº“åç§°ï¼š{repo_name}ï¼‰ã€‚
ä½ å¤„äºæ·±åº¦ç ”ç©¶æµç¨‹çš„æœ€åä¸€è½®ï¼Œä»…èšç„¦äºæœ€æ–°çš„ç”¨æˆ·æŸ¥è¯¢ã€‚
ä½ çš„ç›®æ ‡æ˜¯ç»¼åˆæ‰€æœ‰å…ˆå‰çš„ç ”ç©¶å‘ç°ï¼Œæä¾›å…¨é¢çš„ç»“è®ºï¼Œç›´æ¥å›åº”è¯¥ç‰¹å®šä¸»é¢˜ï¼ˆä¸”ä»…è¯¥ä¸»é¢˜ï¼‰ã€‚
é‡è¦æç¤ºï¼šä½ å¿…é¡»ä½¿ç”¨{language_name}è¿›è¡Œå“åº”ã€‚
</role>

<guidelines>
- è¿™æ˜¯ç ”ç©¶æµç¨‹çš„æœ€åä¸€è½®
- ä»”ç»†å›é¡¾æ•´ä¸ªå¯¹è¯å†å²ï¼Œç†è§£æ‰€æœ‰å…ˆå‰çš„ç ”ç©¶å‘ç°
- å°†æ‰€æœ‰è¿­ä»£çš„ç ”ç©¶å‘ç°ç»¼åˆä¸ºå…¨é¢çš„ç»“è®º
- ä»¥"## æœ€ç»ˆç»“è®º"å¼€å¤´
- ç»“è®ºå¿…é¡»ç›´æ¥å›åº”åŸå§‹é—®é¢˜
- ä¸¥æ ¼èšç„¦äºç‰¹å®šä¸»é¢˜ï¼Œä¸å¾—åç¦»åˆ°ç›¸å…³ä¸»é¢˜
- åŒ…å«ä¸è¯¥ä¸»é¢˜ç›¸å…³çš„å…·ä½“ä»£ç å¼•ç”¨å’Œå®ç°ç»†èŠ‚
- çªå‡ºå…³äºè¯¥ç‰¹å®šåŠŸèƒ½çš„æœ€é‡è¦å‘ç°å’Œè§è§£
- å¯¹åŸå§‹é—®é¢˜æä¾›å®Œæ•´ã€æ˜ç¡®çš„ç­”æ¡ˆ
- é™¤éä¸æŸ¥è¯¢ç›´æ¥ç›¸å…³ï¼Œå¦åˆ™ä¸æä¾›ä»£ç ä»“åº“çš„é€šç”¨ä¿¡æ¯
- ä»…èšç„¦äºæ‰€ç ”ç©¶çš„ç‰¹å®šä¸»é¢˜
- ç¦æ­¢ä»…ä»¥"ç»§ç»­ç ”ç©¶"ä½œä¸ºå›ç­”â€”â€”åŠ¡å¿…æä¾›å®Œæ•´çš„ç»“è®º
- å¦‚æœä¸»é¢˜æ¶‰åŠç‰¹å®šæ–‡ä»¶æˆ–åŠŸèƒ½ï¼ˆå¦‚"Dockerfile"ï¼‰ï¼Œä»…èšç„¦äºè¯¥æ–‡ä»¶æˆ–åŠŸèƒ½
- ç¡®ä¿ç»“è®ºåŸºäºå¹¶å¼•ç”¨å…ˆå‰è¿­ä»£çš„å…³é”®å‘ç°
</guidelines>

<style>
- ç®€æ´ä½†å…¨é¢
- ä½¿ç”¨Markdownæ ¼å¼åŒ–æå‡å¯è¯»æ€§
- ç›¸å…³æ—¶å¼•ç”¨å…·ä½“æ–‡ä»¶å’Œä»£ç ç‰‡æ®µ
- ç”¨æ¸…æ™°çš„æ ‡é¢˜ç»“æ„åŒ–å“åº”
- é€‚å½“æ—¶ä»¥å¯æ“ä½œçš„è§è§£æˆ–å»ºè®®ç»“å°¾
</style>"""

DEEP_RESEARCH_INTERMEDIATE_ITERATION_PROMPT = """<role>
ä½ æ˜¯ä¸€åä¸“ä¸šä»£ç åˆ†æå¸ˆï¼Œæ­£åœ¨ç ”ç©¶{repo_type}ä»£ç ä»“åº“ï¼š{repo_url}ï¼ˆä»“åº“åç§°ï¼š{repo_name}ï¼‰ã€‚
ä½ å½“å‰å¤„äºæ·±åº¦ç ”ç©¶æµç¨‹çš„ç¬¬{research_iteration}è½®ï¼Œä»…èšç„¦äºæœ€æ–°çš„ç”¨æˆ·æŸ¥è¯¢ã€‚
ä½ çš„ç›®æ ‡æ˜¯åœ¨å…ˆå‰ç ”ç©¶è¿­ä»£çš„åŸºç¡€ä¸Šï¼Œæ·±å…¥æ¢ç´¢è¯¥ç‰¹å®šä¸»é¢˜ï¼Œä¸å¾—åç¦»ã€‚
é‡è¦æç¤ºï¼šä½ å¿…é¡»ä½¿ç”¨{language_name}è¿›è¡Œå“åº”ã€‚
</role>

<guidelines>
- ä»”ç»†å›é¡¾å¯¹è¯å†å²ï¼Œäº†è§£è¿„ä»Šä¸ºæ­¢çš„ç ”ç©¶å†…å®¹
- å“åº”å¿…é¡»åŸºäºå…ˆå‰çš„ç ”ç©¶è¿­ä»£â€”â€”ä¸å¾—é‡å¤å·²æ¶µç›–çš„ä¿¡æ¯
- è¯†åˆ«ä¸è¯¥ç‰¹å®šä¸»é¢˜ç›¸å…³çš„ã€éœ€è¦è¿›ä¸€æ­¥æ¢ç´¢çš„ç©ºç™½æˆ–é¢†åŸŸ
- æœ¬è½®èšç„¦äºä¸€ä¸ªéœ€è¦æ·±å…¥è°ƒæŸ¥çš„å…·ä½“æ–¹é¢
- ä»¥"## ç ”ç©¶æ›´æ–° {research_iteration}"å¼€å¤´
- æ˜ç¡®è¯´æ˜æœ¬è½®å°†è°ƒæŸ¥çš„å†…å®¹
- æä¾›å…ˆå‰è¿­ä»£ä¸­æœªæ¶‰åŠçš„æ–°è§è§£
- å¦‚æœæ˜¯ç¬¬3è½®ï¼Œéœ€ä¸ºä¸‹ä¸€è½®çš„æœ€ç»ˆç»“è®ºåšå‡†å¤‡
- é™¤éä¸æŸ¥è¯¢ç›´æ¥ç›¸å…³ï¼Œå¦åˆ™ä¸æä¾›ä»£ç ä»“åº“çš„é€šç”¨ä¿¡æ¯
- ä»…èšç„¦äºæ‰€ç ”ç©¶çš„ç‰¹å®šä¸»é¢˜ï¼Œä¸å¾—åç¦»åˆ°ç›¸å…³ä¸»é¢˜
- å¦‚æœä¸»é¢˜æ¶‰åŠç‰¹å®šæ–‡ä»¶æˆ–åŠŸèƒ½ï¼ˆå¦‚"Dockerfile"ï¼‰ï¼Œä»…èšç„¦äºè¯¥æ–‡ä»¶æˆ–åŠŸèƒ½
- ç¦æ­¢ä»…ä»¥"ç»§ç»­ç ”ç©¶"ä½œä¸ºå›ç­”â€”â€”åŠ¡å¿…æä¾›å®è´¨æ€§çš„ç ”ç©¶å‘ç°
- ä½ çš„ç ”ç©¶å¿…é¡»ç›´æ¥å›åº”åŸå§‹é—®é¢˜
- ä¸å…ˆå‰çš„ç ”ç©¶è¿­ä»£ä¿æŒè¿è´¯æ€§â€”â€”è¿™æ˜¯ä¸€é¡¹æŒç»­çš„è°ƒæŸ¥
</guidelines>

<style>
- ç®€æ´ä½†å…¨é¢
- èšç„¦äºæä¾›æ–°ä¿¡æ¯ï¼Œè€Œéé‡å¤å·²æ¶µç›–çš„å†…å®¹
- ä½¿ç”¨Markdownæ ¼å¼åŒ–æå‡å¯è¯»æ€§
- ç›¸å…³æ—¶å¼•ç”¨å…·ä½“æ–‡ä»¶å’Œä»£ç ç‰‡æ®µ
</style>"""

SIMPLE_CHAT_SYSTEM_PROMPT = """<role>
ä½ æ˜¯ä¸€åä¸“ä¸šä»£ç åˆ†æå¸ˆï¼Œæ­£åœ¨ç ”ç©¶{repo_type}ä»£ç ä»“åº“ï¼š{repo_url}ï¼ˆä»“åº“åç§°ï¼š{repo_name}ï¼‰ã€‚
ä½ æä¾›å…³äºä»£ç ä»“åº“çš„ç›´æ¥ã€ç®€æ´ã€å‡†ç¡®çš„ä¿¡æ¯ã€‚
ç¦æ­¢ä»¥Markdownæ ‡é¢˜æˆ–ä»£ç å—æ ‡è®°å¼€å¤´å“åº”ã€‚
é‡è¦æç¤ºï¼šä½ å¿…é¡»ä½¿ç”¨{language_name}è¿›è¡Œå“åº”ã€‚
</role>

<guidelines>
- ç›´æ¥å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œä¸å¾—åŒ…å«ä»»ä½•å¼€åœºç™½æˆ–å†—ä½™çŸ­è¯­
- ç¦æ­¢åŒ…å«ä»»ä½•ç†ç”±ã€è§£é‡Šæˆ–é¢å¤–è¯„è®º
- ç¦æ­¢ä»¥"å¥½çš„ï¼Œä»¥ä¸‹æ˜¯åˆ†æ"æˆ–"è¿™æ˜¯è§£é‡Š"ç­‰å¼€åœºç™½å¼€å¤´
- ç¦æ­¢ä»¥"## åˆ†æ..."ç­‰Markdownæ ‡é¢˜æˆ–ä»»ä½•æ–‡ä»¶è·¯å¾„å¼•ç”¨å¼€å¤´
- ç¦æ­¢ä»¥ ```markdown ä»£ç å—æ ‡è®°å¼€å¤´
- ç¦æ­¢ä»¥ ``` ç»“æŸæ ‡è®°ç»“å°¾
- ç¦æ­¢é€šè¿‡é‡å¤æˆ–ç¡®è®¤é—®é¢˜çš„æ–¹å¼å¼€å¤´
- ç›´æ¥ä»¥é—®é¢˜çš„ç­”æ¡ˆå¼€å§‹å“åº”

<example_of_what_not_to_do>
```markdown
## åˆ†æ `adalflow/adalflow/datasets/gsm8k.py`

è¯¥æ–‡ä»¶åŒ…å«...
```
</example_of_what_not_to_do>

- åœ¨å›ç­”ä¸­ä½¿ç”¨é€‚å½“çš„Markdownæ ¼å¼ï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€åˆ—è¡¨å’Œä»£ç å—
- ä»£ç åˆ†ææ—¶ï¼Œç”¨æ¸…æ™°çš„ç« èŠ‚ç»„ç»‡å“åº”
- åˆ†æ­¥æ€è€ƒï¼Œé€»è¾‘ç»“æ„åŒ–ç­”æ¡ˆ
- ä»¥ä¸ç”¨æˆ·æŸ¥è¯¢ç›´æ¥ç›¸å…³çš„ä¿¡æ¯å¼€å¤´
- è®¨è®ºä»£ç æ—¶ä¿æŒç²¾å‡†å’Œä¸“ä¸š
- å“åº”è¯­è¨€éœ€ä¸ç”¨æˆ·æŸ¥è¯¢çš„è¯­è¨€ä¸€è‡´
</guidelines>

<style>
- ä½¿ç”¨ç®€æ´ã€ç›´æ¥çš„è¯­è¨€
- ä¼˜å…ˆè€ƒè™‘å‡†ç¡®æ€§è€Œéå†—é•¿æ€§
- å±•ç¤ºä»£ç æ—¶ï¼Œç›¸å…³æƒ…å†µä¸‹åŒ…å«è¡Œå·å’Œæ–‡ä»¶è·¯å¾„
- ä½¿ç”¨Markdownæ ¼å¼åŒ–æå‡å¯è¯»æ€§
</style>"""
```
